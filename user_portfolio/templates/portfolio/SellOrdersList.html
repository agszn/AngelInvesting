{% extends "accounts/profile.html" %}
{% block title %}My Profile{% endblock %}
{% block profile_content %}
<div class="user-porfolio-dashboard">
  <div class="user-portfolio-top">
    <div class="user-dashboard-heading"><h3>Sell Order Summary</h3></div>

    <div class="d-flex align-items-center" style="gap: 12px; flex-wrap: wrap;">
      <!-- Search -->
      <div class="search-details-user">
        <form method="get" class="d-flex" style="gap: 10px;">
          <input id="sell-search-input"
                 type="text"
                 name="search"
                 value="{{ search_query|default_if_none:'' }}"
                 placeholder="Search or type command..."
                 autocomplete="off" />
        </form>
      </div>

      <!-- Advisor Filter -->
      <div class="dropdown">
        <button id="sellAdvisorBtn"
                class="btn btn-sm btn-outline-secondary dropdown-toggle"
                type="button" data-bs-toggle="dropdown" aria-expanded="false">
          {{ selected_advisor.advisor_type|default:"All Advisors" }}
        </button>
        <ul id="sellAdvisorMenu" class="dropdown-menu">
          <li>
            <a class="dropdown-item ajax-filter {% if not selected_advisor %}active{% endif %}"
               data-filter="advisor" data-value="all" href="#">
              {% if not selected_advisor %}✓ {% endif %}All Advisors
            </a>
          </li>
          {% for adv in advisors %}
          <li>
            <a class="dropdown-item ajax-filter {% if selected_advisor and adv.id == selected_advisor.id %}active{% endif %}"
               data-filter="advisor" data-value="{{ adv.id }}" href="#">
              {% if selected_advisor and adv.id == selected_advisor.id %}✓ {% endif %}{{ adv.advisor_type|upper }}
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>

      <!-- Broker Filter -->
      <div class="dropdown">
        <button id="sellBrokerBtn"
                class="btn btn-sm btn-outline-secondary dropdown-toggle"
                type="button" data-bs-toggle="dropdown" aria-expanded="false">
          {{ selected_broker.name|default:"All Brokers" }}
        </button>
        <ul id="sellBrokerMenu" class="dropdown-menu">
          <li>
            <a class="dropdown-item ajax-filter {% if not selected_broker %}active{% endif %}"
               data-filter="broker" data-value="all" href="#">
              {% if not selected_broker %}✓ {% endif %}All Brokers
            </a>
          </li>
          {% for bro in brokers %}
          <li>
            <a class="dropdown-item ajax-filter {% if selected_broker and bro.id == selected_broker.id %}active{% endif %}"
               data-filter="broker" data-value="{{ bro.id }}" href="#">
              {% if selected_broker and bro.id == selected_broker.id %}✓ {% endif %}{{ bro.name }}
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <div class="user-portfolio-table" id="sell-orders-table-container">
    {% include "portfolio/includes/sell_orders_table.html" %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const input      = document.getElementById('sell-search-input');
  const container  = document.getElementById('sell-orders-table-container');
  const advBtn     = document.getElementById('sellAdvisorBtn');
  const broBtn     = document.getElementById('sellBrokerBtn');
  const DELETE_URL = "{% url 'user_portfolio:delete_sell_order' %}";

  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  function loadIntoContainer(url) {
    return fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
      .then(r => r.text())
      .then(html => {
        container.innerHTML = html;
        history.replaceState(null, '', url);
      });
  }

  // Search
  let timer;
  input.addEventListener('input', function() {
    clearTimeout(timer);
    timer = setTimeout(() => {
      const p = new URLSearchParams(window.location.search);
      p.set('search', input.value);
      const url = window.location.pathname + '?' + p.toString();
      loadIntoContainer(url).catch(console.error);
    }, 300);
  });

  // Build URL preserving advisor+broker
  function buildUrl(filterType, value) {
    const url = new URL(window.location.href);
    const p = url.searchParams;
    p.set(filterType, value);
    if (!p.has('advisor')) p.set('advisor', 'all');
    if (!p.has('broker'))  p.set('broker', 'all');
    url.search = p.toString();
    return url.toString();
  }

  // Advisor/Broker filters
  function wireFilterLinks() {
    document.querySelectorAll('.ajax-filter').forEach(a => {
      a.addEventListener('click', function(e) {
        e.preventDefault();
        const filterType = a.dataset.filter;
        const value      = a.dataset.value;
        const labelText  = a.textContent.trim().replace(/^✓\s*/, '');
        const url = buildUrl(filterType, value);

        loadIntoContainer(url).then(() => {
          if (filterType === 'advisor') advBtn.textContent = labelText;
          if (filterType === 'broker')  broBtn.textContent = labelText;
          const menuId = filterType === 'advisor' ? 'sellAdvisorMenu' : 'sellBrokerMenu';
          const menu = document.getElementById(menuId);
          if (menu) {
            Array.from(menu.querySelectorAll('.dropdown-item')).forEach(item => {
              item.classList.remove('active');
              item.innerHTML = item.textContent.trim().replace(/^✓\s*/, '');
            });
            a.classList.add('active');
            a.innerHTML = '✓ ' + labelText;
          }
        }).catch(console.error);
      });
    });
  }
  wireFilterLinks();

  // Pagination delegation
  container.addEventListener('click', function(e) {
    const link = e.target.closest('a.page-link');
    if (link && link.getAttribute('href')) {
      const href = link.getAttribute('href');
      if (href.startsWith('?') || href.startsWith(window.location.pathname)) {
        e.preventDefault();
        const url = href.startsWith('?') ? (window.location.pathname + href) : href;
        loadIntoContainer(url).catch(console.error);
      }
    }
  });

  // Remove (cancel) order
  container.addEventListener('click', function(e) {
    const btn = e.target.closest('.delete-order');
    if (!btn) return;
    const row = btn.closest('tr');
    const orderId = row?.dataset?.orderId;
    if (!orderId) return;

    if (!confirm('Cancel this sell order? This cannot be undone.')) return;

    fetch(DELETE_URL, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({ order_id: orderId })
    })
    .then(async (r) => {
      let data = {};
      try { data = await r.json(); } catch (_) {}
      if (!r.ok || data.ok === false) {
        if (data.reason === 'locked_status') {
          throw new Error('Order is locked (RM_status is not "processing").');
        }
        if (data.reason === 'has_payment') {
          throw new Error('Cannot cancel: payment record already exists.');
        }
        if (r.status === 403) {
          throw new Error('Order not found or not yours.');
        }
        if (r.status === 400) {
          throw new Error('Bad request (missing or invalid order_id).');
        }
        throw new Error('Failed to cancel this order.');
      }
      // Success – fade out then remove
      row.style.transition = 'opacity .2s ease';
      row.style.opacity = '0.4';
      setTimeout(() => row.remove(), 200);
    })
    .catch((err) => {
      alert(err.message || 'Could not cancel this order.');
    });
  });
});
</script>
{% endblock %}
