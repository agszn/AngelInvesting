{% extends "accounts/profile.html" %}
{% block title %}My Profile{% endblock %}
{% block profile_content %}
<div class="user-porfolio-dashboard">
  <div class="user-portfolio-top">
    <div class="user-dashboard-heading"><h3>Sell Order Summary</h3></div>

    <div class="d-flex align-items-center" style="gap: 12px; flex-wrap: wrap;">
      <!-- Search -->
      <div class="search-details-user">
        <form method="get" class="d-flex" style="gap: 10px;">
          <input id="sell-search-input"
                 type="text"
                 name="search"
                 value="{{ search_query|default_if_none:'' }}"
                 placeholder="Search or type command..."
                 autocomplete="off" />
        </form>
      </div>

      <!-- Advisor Filter -->
      <div class="dropdown">
        <button id="sellAdvisorBtn" class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          {{ selected_advisor.advisor_type|default:"Advisor" }}
        </button>
        <ul id="sellAdvisorMenu" class="dropdown-menu">
          <li>
            <a class="dropdown-item ajax-filter {% if not selected_advisor %}active{% endif %}"
               data-filter="advisor" data-value=""
               href="?{% if selected_broker %}broker={{ selected_broker.id }}{% endif %}{% if search_query %}{% if selected_broker %}&{% endif %}search={{ search_query|urlencode }}{% endif %}{% if sort %}{% if selected_broker or search_query %}&{% endif %}sort={{ sort }}{% endif %}">
              {% if not selected_advisor %}✓ {% endif %}All Advisors
            </a>
          </li>
          {% for adv in advisors %}
          <li>
            <a class="dropdown-item ajax-filter {% if selected_advisor and adv.id == selected_advisor.id %}active{% endif %}"
               data-filter="advisor" data-value="{{ adv.id }}"
               href="?advisor={{ adv.id }}{% if selected_broker %}&broker={{ selected_broker.id }}{% endif %}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}">
              {% if selected_advisor and adv.id == selected_advisor.id %}✓ {% endif %}{{ adv.advisor_type|upper }}
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>

      <!-- Broker Filter -->
      <div class="dropdown">
        <button id="sellBrokerBtn" class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          {{ selected_broker.name|default:"Broker" }}
        </button>
        <ul id="sellBrokerMenu" class="dropdown-menu">
          <li>
            <a class="dropdown-item ajax-filter {% if not selected_broker %}active{% endif %}"
               data-filter="broker" data-value=""
               href="?{% if selected_advisor %}advisor={{ selected_advisor.id }}{% endif %}{% if search_query %}{% if selected_advisor %}&{% endif %}search={{ search_query|urlencode }}{% endif %}{% if sort %}{% if selected_advisor or search_query %}&{% endif %}sort={{ sort }}{% endif %}">
              {% if not selected_broker %}✓ {% endif %}All Brokers
            </a>
          </li>
          {% for bro in brokers %}
          <li>
            <a class="dropdown-item ajax-filter {% if selected_broker and bro.id == selected_broker.id %}active{% endif %}"
               data-filter="broker" data-value="{{ bro.id }}"
               href="?broker={{ bro.id }}{% if selected_advisor %}&advisor={{ selected_advisor.id }}{% endif %}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}">
              {% if selected_broker and bro.id == selected_broker.id %}✓ {% endif %}{{ bro.name }}
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <div class="user-portfolio-table" id="sell-orders-table-container">
    {% include "portfolio/includes/sell_orders_table.html" %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('sell-search-input');
  const container = document.getElementById('sell-orders-table-container');
  const advBtn = document.getElementById('sellAdvisorBtn');
  const broBtn = document.getElementById('sellBrokerBtn');

  // Search (AJAX)
  let timer;
  input.addEventListener('input', function() {
    clearTimeout(timer);
    timer = setTimeout(() => {
      const p = new URLSearchParams(window.location.search);
      p.set('search', input.value);
      const url = window.location.pathname + '?' + p.toString();
      fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(r => r.text())
        .then(html => {
          container.innerHTML = html;
          history.replaceState(null, '', url);
        });
    }, 300);
  });

  // Advisor/Broker filters (AJAX)
  function wireFilterLinks() {
    document.querySelectorAll('.ajax-filter').forEach(a => {
      a.addEventListener('click', function(e) {
        e.preventDefault();
        const url = a.getAttribute('href');
        const filterType = a.dataset.filter; // 'advisor' or 'broker'
        const labelText = a.textContent.trim().replace(/^✓\s*/, '');

        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
          .then(r => r.text())
          .then(html => {
            container.innerHTML = html;
            history.replaceState(null, '', url);

            // Update dropdown button label
            if (filterType === 'advisor') advBtn.textContent = labelText;
            if (filterType === 'broker')  broBtn.textContent  = labelText;

            // Update active state + check mark
            const menuId = filterType === 'advisor' ? 'sellAdvisorMenu' : 'sellBrokerMenu';
            const menu = document.getElementById(menuId);
            if (menu) {
              Array.from(menu.querySelectorAll('.dropdown-item')).forEach(item => {
                item.classList.remove('active');
                item.innerHTML = item.textContent.trim().replace(/^✓\s*/, '');
              });
              a.classList.add('active');
              if (!a.textContent.trim().startsWith('✓')) {
                a.innerHTML = '✓ ' + a.textContent.trim();
              }
            }
          })
          .catch(console.error);
      });
    });
  }

  wireFilterLinks();
});
</script>
{% endblock %}
