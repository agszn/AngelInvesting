{% extends "accounts/profile.html" %}
{% block title %}My Profile{% endblock %}

{% block profile_content %}
<div class="user-porfolio-dashboard">
  <div class="user-portfolio-top">
    <div class="user-dashboard-heading"><h3>Buy Order Summary</h3></div>

    <!-- Search Bar -->
    <div class="search-details-user">
      <form method="get" class="d-flex" style="gap: 10px;">
        <input id="buy-search-input" type="text" 
               name="search" 
               value="{{ current_filters.search|default_if_none:'' }}" 
               placeholder="Search or type command..." 
               autocomplete="off" />
      </form>
    </div>

    <!-- Dropdown Filters -->
    <div class="search-details-dropdown">
      <!-- Advisor Dropdown -->
      <div class="dropdown">
        <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          {{ selected_advisor.advisor_type|default:"Advisor" }}
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="?{% if current_filters.broker %}broker={{ current_filters.broker }}&{% endif %}{% if current_filters.type %}type={{ current_filters.type }}&{% endif %}{% if current_filters.search %}search={{ current_filters.search }}&{% endif %}">All Advisors</a></li>
          {% for adv in advisors %}
            <li><a class="dropdown-item" href="?advisor={{ adv.id }}{% if current_filters.broker %}&broker={{ current_filters.broker }}{% endif %}{% if current_filters.type %}&type={{ current_filters.type }}{% endif %}{% if current_filters.search %}&search={{ current_filters.search }}{% endif %}">{{ adv.advisor_type|upper }}</a></li>
          {% endfor %}
        </ul>
      </div>

      <!-- Broker Dropdown -->
      <div class="dropdown">
        <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          {{ selected_broker.name|default:"Broker" }}
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="?{% if current_filters.advisor %}advisor={{ current_filters.advisor }}&{% endif %}{% if current_filters.type %}type={{ current_filters.type }}&{% endif %}{% if current_filters.search %}search={{ current_filters.search }}&{% endif %}">All Brokers</a></li>
          {% for bro in brokers %}
            <li><a class="dropdown-item" href="?broker={{ bro.id }}{% if current_filters.advisor %}&advisor={{ current_filters.advisor }}{% endif %}{% if current_filters.type %}&type={{ current_filters.type }}{% endif %}{% if current_filters.search %}&search={{ current_filters.search }}{% endif %}">{{ bro.name }}</a></li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <!-- Table Section -->
  <div style="overflow-x: auto;">
    <div style="min-width: 800px;">
      <div class="user-portfolio-table">
        {% include "portfolio/includes/buy_orders_table.html" %}
      </div>
    </div>
  </div>
</div>

<!-- AJAX Script -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('buy-search-input');
    const tableContainer = document.querySelector('.user-portfolio-table');

    if (!searchInput || !tableContainer) return;

    let debounceTimer;

    searchInput.addEventListener('input', function () {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(function () {
        const query = encodeURIComponent(searchInput.value);

        const advisor = "{{ current_filters.advisor|default_if_none:'' }}";
        const broker = "{{ current_filters.broker|default_if_none:'' }}";
        const type = "{{ current_filters.type|default_if_none:'' }}";

        let url = `{% url 'user_portfolio:buy_orders' %}?search=${query}`;
        if (advisor) url += `&advisor=${advisor}`;
        if (broker) url += `&broker=${broker}`;
        if (type) url += `&type=${type}`;

        fetch(url, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.text())
        .then(html => {
          tableContainer.innerHTML = html;
        })
        .catch(err => console.error('Buy search failed:', err));
      }, 300);
    });
  });
</script>
{% endblock %}
