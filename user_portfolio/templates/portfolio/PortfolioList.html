{% extends "accounts/profile.html" %}
{% block title %}My Profile{% endblock %}
{% block profile_content %}
<div class="user-porfolio-dashboard">
  <div class="user-portfolio-top">
    <div class="user-dashboard-heading"><h3>Holdings</h3></div>
    <div class="d-flex align-items-center" style="gap: 12px; flex-wrap: wrap;">
      <!-- Download start xlsx -->
      <a id="download-xlsx-btn" class="btn btn-sm btn-success" href="#">
        ⬇️ Download .xlsx
      </a>
      <script>
        (function () {
          const btn = document.getElementById('download-xlsx-btn');
          if (!btn) return;
          btn.addEventListener('click', function (e) {
            e.preventDefault();
            const url = new URL(window.location.href);
            url.searchParams.set('download', 'xlsx');
            window.location.href = url.toString();
          });
        })();
      </script>
      <!-- Download end xlsx -->

      <!-- Search -->
      <div class="search-details-user">
        <form method="get" class="d-flex" style="gap: 10px;">
          <input id="portfolio-search-input"
                 type="text"
                 name="search"
                 value="{{ search_query|default_if_none:'' }}"
                 placeholder="Search or type command..."
                 autocomplete="off" />
        </form>
      </div>

      <!-- Advisor Filter -->
      <div class="dropdown">
        <button id="advisorFilterBtn"
                class="btn btn-sm btn-outline-secondary dropdown-toggle"
                type="button"
                data-bs-toggle="dropdown"
                aria-expanded="false">
          {{ selected_advisor.advisor_type|default:"Thangiv" }}
        </button>
        <ul id="advisorMenu" class="dropdown-menu">
          <li>
            <a class="dropdown-item ajax-filter {% if not selected_advisor %}active{% endif %}"
               data-filter="advisor"
               data-value="all"
               href="#">
              {% if not selected_advisor %}✓ {% endif %}All Advisors
            </a>
          </li>
          {% for adv in advisors %}
          <li>
            <a class="dropdown-item ajax-filter {% if selected_advisor and adv.id == selected_advisor.id %}active{% endif %}"
               data-filter="advisor"
               data-value="{{ adv.id }}"
               href="#">
              {% if selected_advisor and adv.id == selected_advisor.id %}✓ {% endif %}{{ adv.advisor_type|upper }}
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>

      <!-- Broker Filter -->
      <div class="dropdown">
        <button id="brokerFilterBtn"
                class="btn btn-sm btn-outline-secondary dropdown-toggle"
                type="button"
                data-bs-toggle="dropdown"
                aria-expanded="false">
          {{ selected_broker.name|default:"All Brokers" }}
        </button>
        <ul id="brokerMenu" class="dropdown-menu">
          <li>
            <a class="dropdown-item ajax-filter {% if not selected_broker %}active{% endif %}"
               data-filter="broker"
               data-value="all"
               href="#">
              {% if not selected_broker %}✓ {% endif %}All Brokers
            </a>
          </li>
          {% for bro in brokers %}
          <li>
            <a class="dropdown-item ajax-filter {% if selected_broker and bro.id == selected_broker.id %}active{% endif %}"
               data-filter="broker"
               data-value="{{ bro.id }}"
               href="#">
              {% if selected_broker and bro.id == selected_broker.id %}✓ {% endif %}{{ bro.name }}
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <div class="user-portfolio-table" id="portfolio-table-container">
    {% include "portfolio/includes/portfolio_table.html" %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('portfolio-search-input');
  const tableContainer = document.getElementById('portfolio-table-container');
  const advisorBtn = document.getElementById('advisorFilterBtn');
  const brokerBtn = document.getElementById('brokerFilterBtn');

  // Build new URL with all parameters preserved
  function buildUrl(params) {
    const url = new URL(window.location.href);
    const p = url.searchParams;

    // Update or set new parameters
    Object.entries(params).forEach(([key, value]) => {
      if (value) {
        p.set(key, value);
      } else {
        p.delete(key);
      }
    });

    // Preserve existing parameters if not overridden
    if (!params.hasOwnProperty('advisor')) p.set('advisor', p.get('advisor') || 'all');
    if (!params.hasOwnProperty('broker')) p.set('broker', p.get('broker') || 'all');
    if (!params.hasOwnProperty('search')) p.set('search', p.get('search') || '');
    if (!params.hasOwnProperty('page')) p.set('page', p.get('page') || '1');
    if (!params.hasOwnProperty('sort')) p.set('sort', p.get('sort') || '');
    if (!params.hasOwnProperty('dir')) p.set('dir', p.get('dir') || 'desc');

    url.search = p.toString();
    return url.toString();
  }

  // --- Search with AJAX ---
  let t;
  input.addEventListener('input', function() {
    clearTimeout(t);
    t = setTimeout(() => {
      const url = buildUrl({ search: input.value, page: '1' });
      fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(r => r.text())
        .then(html => {
          tableContainer.innerHTML = html;
          history.replaceState(null, '', url);
          wireFilterLinks();
          wireSortLinks();
        })
        .catch(console.error);
    }, 300);
  });

  // --- Filter with AJAX + update button label + active item ---
  function wireFilterLinks() {
    document.querySelectorAll('.ajax-filter').forEach(a => {
      a.addEventListener('click', function(e) {
        e.preventDefault();
        const filterType = a.dataset.filter; // 'advisor' or 'broker'
        const value = a.dataset.value;
        const labelText = a.textContent.trim().replace(/^✓\s*/, '');

        const url = buildUrl({ [filterType]: value, page: '1' });

        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
          .then(r => r.text())
          .then(html => {
            tableContainer.innerHTML = html;
            history.replaceState(null, '', url);

            // Update dropdown button label
            if (filterType === 'advisor') advisorBtn.textContent = labelText;
            if (filterType === 'broker') brokerBtn.textContent = labelText;

            // Update active state + checkmark
            const menuId = filterType === 'advisor' ? 'advisorMenu' : 'brokerMenu';
            const menu = document.getElementById(menuId);
            if (menu) {
              Array.from(menu.querySelectorAll('.dropdown-item')).forEach(item => {
                item.classList.remove('active');
                item.innerHTML = item.textContent.trim().replace(/^✓\s*/, '');
              });
              a.classList.add('active');
              a.innerHTML = '✓ ' + labelText;
            }

            wireSortLinks(); // Re-wire sort links after filter update
          })
          .catch(console.error);
      });
    });
  }

  // --- Sort with AJAX ---
  function wireSortLinks() {
    document.querySelectorAll('.sort-link').forEach(a => {
      a.addEventListener('click', function(e) {
        e.preventDefault();
        const sort = a.dataset.sort; // 'inv' or 'mkt'
        const dir = a.dataset.dir; // 'asc' or 'desc'

        const url = buildUrl({ sort: sort, dir: dir, page: '1' });

        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
          .then(r => r.text())
          .then(html => {
            tableContainer.innerHTML = html;
            history.replaceState(null, '', url);
            wireFilterLinks();
            wireSortLinks(); // Re-wire sort links after update
          })
          .catch(console.error);
      });
    });
  }

  wireFilterLinks();
  wireSortLinks();
});
</script>
{% endblock %}