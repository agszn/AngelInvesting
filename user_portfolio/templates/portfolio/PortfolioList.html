{% extends "accounts/profile.html" %}
{% block title %}My Profile{% endblock %}
{% block profile_content %}
<div class="user-porfolio-dashboard">
  <div class="user-portfolio-top">
    <div class="user-dashboard-heading"><h3>Holdings</h3></div>

    <div class="d-flex align-items-center" style="gap: 12px; flex-wrap: wrap;">
      <!-- Search -->
      <div class="search-details-user">
        <form method="get" class="d-flex" style="gap: 10px;">
          <input id="portfolio-search-input"
                 type="text"
                 name="search"
                 value="{{ search_query|default_if_none:'' }}"
                 placeholder="Search or type command..."
                 autocomplete="off" />
        </form>
      </div>

      <!-- Advisor Filter -->
      <div class="dropdown">
        <button id="advisorFilterBtn" class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          {{ selected_advisor.advisor_type|default:"Thangiv" }}
        </button>

        <ul id="advisorMenu" class="dropdown-menu">
          <li>
            <a class="dropdown-item ajax-filter {% if not selected_advisor %}active{% endif %}"
              data-filter="advisor" data-value="all"
              href="?advisor=all{% if selected_broker %}&broker={{ selected_broker.id }}{% endif %}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}">
              {% if not selected_advisor %}✓ {% endif %}All Advisors
            </a>
          </li>

          {% for adv in advisors %}
            <li>
              <a class="dropdown-item ajax-filter {% if selected_advisor and adv.id == selected_advisor.id %}active{% endif %}"
                data-filter="advisor" data-value="{{ adv.id }}"
                href="?advisor={{ adv.id }}{% if selected_broker %}&broker={{ selected_broker.id }}{% endif %}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}">
                {% if selected_advisor and adv.id == selected_advisor.id %}✓ {% endif %}{{ adv.advisor_type|upper }}
              </a>
            </li>
          {% endfor %}
        </ul>
      </div>


      <!-- Broker Filter -->
      <div class="dropdown">
        <button id="brokerFilterBtn" class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          {{ selected_broker.name|default:"Broker" }}
        </button>
        <ul id="brokerMenu" class="dropdown-menu">
          <li>
            <a class="dropdown-item ajax-filter {% if not selected_broker %}active{% endif %}"
               data-filter="broker" data-value=""
               href="?{% if selected_advisor %}advisor={{ selected_advisor.id }}{% endif %}{% if search_query %}{% if selected_advisor %}&{% endif %}search={{ search_query|urlencode }}{% endif %}">
              {% if not selected_broker %}✓ {% endif %}All Brokers
            </a>
          </li>
          {% for bro in brokers %}
          <li>
            <a class="dropdown-item ajax-filter {% if selected_broker and bro.id == selected_broker.id %}active{% endif %}"
               data-filter="broker" data-value="{{ bro.id }}"
               href="?broker={{ bro.id }}{% if selected_advisor %}&advisor={{ selected_advisor.id }}{% endif %}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}">
              {% if selected_broker and bro.id == selected_broker.id %}✓ {% endif %}{{ bro.name }}
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <div class="user-portfolio-table" id="portfolio-table-container" >
    {% include "portfolio/includes/portfolio_table.html" %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('portfolio-search-input');
  const tableContainer = document.getElementById('portfolio-table-container');
  const advisorBtn = document.getElementById('advisorFilterBtn');
  const brokerBtn  = document.getElementById('brokerFilterBtn');

  // --- Search with AJAX ---
  let t;
  input.addEventListener('input', function() {
    clearTimeout(t);
    t = setTimeout(() => {
      const p = new URLSearchParams(window.location.search);
      p.set('search', input.value);
      const url = window.location.pathname + '?' + p.toString();
      fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(r => r.text())
        .then(html => {
          tableContainer.innerHTML = html;
          history.replaceState(null, '', url);
        });
    }, 300);
  });

  // --- Filter with AJAX + update button label + active item ---
  function wireFilterLinks() {
    document.querySelectorAll('.ajax-filter').forEach(a => {
      a.addEventListener('click', function(e) {
        e.preventDefault();
        const url = a.getAttribute('href');
        const filterType = a.dataset.filter; // 'advisor' or 'broker'
        const labelText  = a.textContent.trim().replace(/^✓\s*/, ''); // strip leading check

        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
          .then(r => r.text())
          .then(html => {
            tableContainer.innerHTML = html;
            history.replaceState(null, '', url);

            // update the dropdown button label instantly in the UI
            if (filterType === 'advisor') advisorBtn.textContent = labelText;
            if (filterType === 'broker')  brokerBtn.textContent  = labelText;

            // update active state + checkmark in the open dropdown
            const menuId = filterType === 'advisor' ? 'advisorMenu' : 'brokerMenu';
            const menu = document.getElementById(menuId);
            if (menu) {
              Array.from(menu.querySelectorAll('.dropdown-item')).forEach(item => {
                item.classList.remove('active');
                item.innerHTML = item.textContent.trim().replace(/^✓\s*/, '');
              });
              a.classList.add('active');
              if (!a.textContent.trim().startsWith('✓')) {
                a.innerHTML = '✓ ' + a.textContent.trim();
              }
            }
          })
          .catch(console.error);
      });
    });
  }

  wireFilterLinks();
});
</script>
{% endblock %}
