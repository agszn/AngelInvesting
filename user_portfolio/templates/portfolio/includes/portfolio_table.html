{% comment %} portfolio/includes/portfolio_table.html {% endcomment %}
<table class="user-portfolio-toptable">
  <thead class="user-portfolio-head1">
    <tr>
      <th>Stock Name</th>
      <th>Advisor</th>
      <th>CMP</th>
      <th>Avg. Price</th>
      <th>Quantity</th>
      <th>
        <a href="#" class="sort-link" data-sort="inv" data-dir="{% if sort == 'inv' and dir == 'desc' %}asc{% else %}desc{% endif %}" style="color: white;text-decoration: none;">
          Inv.  Amt {% if sort == 'inv' %}{% if dir == 'desc' %}↓{% else %}↑{% endif %}{% else %}↕{% endif %}
        </a>
      </th>
      <th>
        <a href="#" class="sort-link" data-sort="mkt" data-dir="{% if sort == 'mkt' and dir == 'desc' %}asc{% else %}desc{% endif %}" style="color: white;text-decoration: none;">
          Mkt Value {% if sort == 'mkt' %}{% if dir == 'desc' %}↓{% else %}↑{% endif %}{% else %}↕{% endif %}
        </a>
      </th>
      <th>Overall P/L</th>
      <th>Day’s P/L</th>
    </tr>
  </thead>
  <tbody>
    {% if holdings.object_list %}
      {% for h in holdings %}
        <tr style="background: {% cycle '#f5f9ff' 'white' %};">
          <td>
            <a href="{% url 'unlisted_stock_marketplace:stock_detail' h.stock.id %}" style="text-decoration: none;color: black;">
              {{ h.stock.company_name }} - 
            </a>
            <button
              data-broker-id="{{ h.broker.id|default:'' }}"
              onclick="openBuyModal('{{ h.stock.id }}', '{{ h.stock.company_name|escapejs }}', '{{ h.share_price|floatformat:2 }}', '', '{% url 'user_portfolio:buy_stock' h.stock.id %}', '{{ h.advisor.id|default:'' }}', '{{ h.broker.id|default:'' }}')"
              style="background-color:#39B54A;color:#fff;padding:2px 6px;border-radius:4px;cursor:pointer;font-size:12px;margin-left:6px;border:none;">
              B
            </button>
            <button
              {% if h.quantity_held == 0 %}disabled{% endif %}
              data-broker-id="{{ h.broker.id|default:'' }}"
              onclick="openSellModal('{{ h.stock.id }}', '{{ h.stock.company_name|escapejs }}', '{{ h.share_price|floatformat:2 }}', '', '{% url 'user_portfolio:sell_stock' h.stock.id %}', '{{ h.advisor.id|default:'' }}', '{{ h.broker.id|default:'' }}', '{{ h.quantity_held }}')"
              style="background-color:#FF4E4E;color:#fff;padding:2px 6px;border-radius:4px;cursor:pointer;font-size:12px;margin-left:4px;border:none;">
              S
            </button>
          </td>
          <td>{{ h.advisor.advisor_type|default:"-" }}</td>
          <td>
            {% if h.share_price is not None %}
              ₹{{ h.share_price|floatformat:2 }}
            {% elif h.stock and h.stock.share_price is not None %}
              ₹{{ h.stock.share_price|floatformat:2 }}
            {% else %}
              -
            {% endif %}
          </td>
          <td>₹{{ h.avg_price|floatformat:2 }}</td>
          <td>{{ h.quantity_held }}</td>
          <td>₹{{ h.investment_amount }}</td>
          <td>₹{{ h.market_value }}</td>
          <td>₹{{ h.overall_gain_loss }} ({{ h.overall_gain_percent|floatformat:2 }}%)</td>
          <td>₹{{ h.day_gain_loss }} ({{ h.day_gain_percent|floatformat:2 }}%)</td>
        </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="9">No holdings yet.</td>
      </tr>
    {% endif %}
  </tbody>
</table>

<div class="pagination">
  {% if page_obj.has_previous %}
    <a href="?page=1{% if sort %}&sort={{ sort }}&dir={{ dir }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if advisor_param %}&advisor={{ advisor_query_value }}{% endif %}{% if broker_param %}&broker={{ broker_query_value }}{% endif %}">« First</a>
    <a href="?page={{ page_obj.previous_page_number }}{% if sort %}&sort={{ sort }}&dir={{ dir }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if advisor_param %}&advisor={{ advisor_query_value }}{% endif %}{% if broker_param %}&broker={{ broker_query_value }}{% endif %}">Previous</a>
  {% endif %}
  <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if sort %}&sort={{ sort }}&dir={{ dir }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if advisor_param %}&advisor={{ advisor_query_value }}{% endif %}{% if broker_param %}&broker={{ broker_query_value }}{% endif %}">Next</a>
    <a href="?page={{ page_obj.paginator.num_pages }}{% if sort %}&sort={{ sort }}&dir={{ dir }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if advisor_param %}&advisor={{ advisor_query_value }}{% endif %}{% if broker_param %}&broker={{ broker_query_value }}{% endif %}">Last »</a>
  {% endif %}
</div>