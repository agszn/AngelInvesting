{% extends "baseStructureRM.html" %}

{% block title %}Buy Order Summary{% endblock %}
{% block SubTitleRM %}Buy Order Summary{% endblock %}

{% block RMprofile_content %}
  {% if order %}
    <h6 style="padding-top: 2%;">Order Details</h6>
    <table class="RMbuyorder-table">
      <thead>
        <tr>
          <th>Sl.no</th>
          <th>Order ID</th>
          <th>Date</th>
          <th>Time</th>
          <!-- <th>Client Name</th>
          <th>Client ID</th>
          <th>RM</th> -->
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>{{ order.id }}</td>
          <td>{{ order.order_id }}</td>
          <td>{{ order.timestamp|date:"d-m-Y" }}</td>
          <td>{{ order.timestamp|time:"h:i A" }}</td>
          <!-- <td>{{ order.user.profile.user.username }}</td>
          <td>{{ order.user.profile.custom_user_id }}</td>
          <td>{{ order.user.profile.user.assigned_rm }}</td> -->
        </tr>
      </tbody>
    </table>

    <h6 style="padding-top: 2%;">Client Details</h6>
    <table class="RMbuyorder-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Custom User ID</th>
          <th>PAN Number</th>
          <th>Email</th>
          <th>Mobile Number</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>{{ order.user.profile.user.username }}</td>
          <td>{{ order.user.profile.custom_user_id }}</td>
          <td>{{ order.user.profile.pan_number }}</td>
          <td>{{ order.user.email }}</td>
          <td>{{ order.user.profile.mobile_number }}</td>
        </tr>
      </tbody>
    </table>

    {% if cmr %}
      <h6 style="padding-top: 2%;">Broker Details</h6>
      <table class="RMbuyorder-table">
        <thead>
          <tr>
            <th>Broker Name</th>
            <th>Broker ID</th>
            <th>Client ID</th>
            <th>Broker PAN Number</th>
            <th>Broker Email</th>
            <th>Broker Contact</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>{{ cmr.broker.name }}</td>
            <td>{{ cmr.broker.broker_id }}</td>
            <td>{{ cmr.client_id_input }}</td>
            <td>{{ cmr.broker.pan }}</td>
            <td>{{ cmr.broker.email }}</td>
            <td>{{ cmr.broker.contact }}</td>
          </tr>
        </tbody>
      </table>
    {% else %}
      <p>No broker details found.</p>
    {% endif %}

    {% if bank_accounts %}
      <h6 style="padding-top: 2%;">Bank Account Details</h6>
      <table class="RMbuyorder-table">
        <thead>
          <tr>
            <th>Bank Name</th>
            <th>Account Holder Name</th>
            <th>Account Number</th>
            <th>IFSC Code</th>
            <th>Account Type</th>
          </tr>
        </thead>
        <tbody>
          {% for account in bank_accounts %}
          <tr>
            <td>{{ account.bank_name }}</td>
            <td>{{ account.account_holder_name }}</td>
            <td>{{ account.account_number }}</td>
            <td>{{ account.ifsc_code }}</td>
            <td>{{ account.account_type }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No bank account details found.</p>
    {% endif %}


<!-- bankaccount details end  -->

<!-- Add Payment Button -->
<div class="RMpaymentAddsection" style="padding-top: 2%;">
  <button class="RMpaymentAdd btn btn-primary" data-bs-toggle="modal" data-bs-target="#buyModal">Add Payment</button> Total Balance - {{ remaining_amount }}
</div>

<!-- Payment Records Table -->
<table class="RMbuyorder-table">
  <thead>
    <tr>
      <th>SLNO</th>
      <th>Date</th>
      <th>Bank</th>
      <th>Enter Amount</th>
      <th>Remaining Amount</th>
      <th>Upload Screenshot</th>
      <th>Remark</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for payment in rm_view.payment_records.all %}
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>{{ payment.date|date:"d-m-Y" }}</td>
      <td>{{ payment.bank_name }}</td>
      <td>{{ payment.amount }}</td>
      <td>{{ payment.remaining_amount }}</td>
      <td>
        {% if payment.screenshot %}
          <a href="{{ payment.screenshot.url }}" target="_blank">üëÅÔ∏è‚Äçüó®Ô∏è</a>
        {% else %}
          N/A
        {% endif %}
      </td>
      <td>{{ payment.remark }}</td>
      <td>{{ payment.payment_status|capfirst }}</td>
      <td>
        <!-- Edit Button -->
        <button type="button"
          class="btn btn-sm btn-warning"
          onclick='openPaymentEditModal({
            id: {{ payment.id }},
            bank_name: "{{ payment.bank_name }}",
            amount: "{{ payment.amount }}",
            remaining_amount: "{{ payment.remaining_amount }}",
            remark: "{{ payment.remark }}",
            payment_status: "{{ payment.payment_status }}",
            screenshot_url: "{% if payment.screenshot %}{{ payment.screenshot.url }}{% else %}#{% endif %}"
          })'>
          ‚úèÔ∏è Edit
        </button>

        <!-- <a href="{% url 'RM_User:delete_payment' payment.id %}" class="btn btn-sm btn-danger" 
          onclick="return confirm('Are you sure you want to delete this payment?');">
          üóëÔ∏è
        </a> -->
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="9">No payment records found.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Payment Modal -->
<div class="modal fade" id="buyModal" tabindex="-1" aria-labelledby="buyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg-custom">
    <div class="modal-content custom-modal">
      <div class="modal-header">
        <h5 class="modal-title" id="buyModalLabel">Add/Edit Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <form id="paymentForm" method="post" enctype="multipart/form-data" action="{% url 'RM_User:add_payment' order_id=order.order_id %}">
          {% csrf_token %}
          <div class="row g-3">
            <div class="col-6">
              <label class="form-label">Select Bank</label>
              <select name="bank_name" class="form-select" required>
                {% for bank in bank_accounts %}
                  <option value="{{ bank.bank_name }}">{{ bank.bank_name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-6">
              <label class="form-label">Remaining Amount</label>
              <input type="number" name="remaining_amount" class="form-control" step="0.01" value="{{ remaining_amount|floatformat:2 }}">
            </div>

            <div class="col-6">
              <label class="form-label">Enter Amount</label>
              <input type="number" name="amount" class="form-control" required step="0.01">
            </div>

            <div class="col-6">
              <label class="form-label">Upload Screenshot</label>
              <input type="file" name="screenshot" class="form-control">
              <a href="#" id="screenshotLink" target="_blank" style="display: none;">View Existing</a>
            </div>

            <div class="col-6">
              <label class="form-label">Remark</label>
              <input type="text" name="remark" class="form-control">
            </div>

            <div class="col-6">
              <label class="form-label">Status</label>
              <select name="payment_status" class="form-select">
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
          </div>

          <div class="modal-footer justify-content-center mt-3">
            <button type="submit" class="btn btn-success w-100" id="submitBtn">‚úîÔ∏è Submit</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>





  <!-- Order Transaction Details -->

    <h6 style="padding-top: 2%;">Order Transaction Details</h6>
    <table class="RMbuyorder-table">
      <thead>
        <tr>
          <th>SLNO</th>
          <th>Broker</th>
          <th>ISIN Number</th>
          <th>Stock</th>
          <th>Order Type</th>
          <th>Share Price</th>
          <th>Buy Price</th>
          <th>Qty</th>
          <th>Amount</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for item in TransactionDetails %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ item.broker.name }}</td>
            <td>{{ item.stock.isin_no }}</td>
            <td>{{ item.stock.company_name }}</td>
            <td>{{ item.order_type }}</td>
            <td>{{ item.stock.share_price }}</td>
            <td>{{ item.price_per_share }}</td>
            <td>{{ item.quantity }}</td>
            <td>{{ item.total_amount }}</td>
            <td>{{ item.status }}</td>
            <td>
              <a href="{% url 'RM_User:edit_transaction' item.id %}" class="btn btn-sm btn-outline-primary"> ‚úèÔ∏è</a>

              <!-- <a href="{% url 'RM_User:delete_transaction' pk=item.id %}"
                onclick="return confirm('Are you sure you want to delete this transaction?');"
                class="btn btn-danger btn-sm"
                title="Delete Transaction"
                aria-label="Delete Transaction">
                üóëÔ∏è
              </a> -->



            </td>

          </tr>
        {% empty %}
          <tr>
            <td colspan="10" class="text-center">No transaction details available.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="RMpayment-process">
      <h4><strong>Total Amount: </strong> {{ order.total_amount }}</h4>
      <button class="RMpayment-button">Process To Account Department</button>
    </div>

  {% else %}
    <p>No order details found.</p>
  {% endif %}

<!-- JavaScript -->
<script>
  // Reset form for Add Payment
  document.querySelector('.RMpaymentAdd').addEventListener('click', function () {
    const form = document.getElementById('paymentForm');
    form.reset();
    form.action = "{% url 'RM_User:add_payment' order_id=order.order_id %}";

    // Set remaining amount again in add mode
    form.elements['remaining_amount'].value = "{{ remaining_amount|floatformat:2 }}";

    document.getElementById('submitBtn').innerText = '‚úîÔ∏è Submit';
    document.getElementById('screenshotLink').style.display = 'none';
  });

  function openPaymentEditModal(payment) {
    const form = document.getElementById('paymentForm');

    // Set form action URL for edit
    form.action = `/RM_User/payment/edit/${payment.id}/`;

    // Fill fields
    form.elements['bank_name'].value = payment.bank_name;
    form.elements['amount'].value = payment.amount;
    form.elements['remaining_amount'].value = payment.remaining_amount;
    form.elements['remark'].value = payment.remark;
    form.elements['payment_status'].value = payment.payment_status;

    // Screenshot link
    const link = document.getElementById('screenshotLink');
    if (payment.screenshot_url && payment.screenshot_url !== "#") {
      link.href = payment.screenshot_url;
      link.style.display = 'block';
    } else {
      link.style.display = 'none';
    }

    // Change button label
    document.getElementById('submitBtn').innerText = '‚úîÔ∏è Update';

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('buyModal'));
    modal.show();
  }
</script>

{% endblock %}
