{% extends "baseStructureRM.html" %}
{% load role_status_filters %}
{% block title %}Buy Order Summary{% endblock %}
{% block SubTitleRM %}Relationship Manager - Buy Order Summary{% endblock %}

{% block RMprofile_content %}
  {% if order %}
    <div class="SMtable-head">
      <div class="order-details-transaction">
          <table class="user-portfolio-toptable2">
            <thead class="user-portfolio-head-admin">
              <tr>
                <th>Sl.no</th>
                <th>Order ID</th>
                <th>Date</th>
                <th>Time</th>
                <!-- <th>Client Name</th>
                <th>Client ID</th>
                <th>RM</th> -->
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>{{ order.id }}</td>
                <td>{{ order.order_id }}</td>
                <td>{{ order.timestamp|date:"d-m-Y" }}</td>
                <td>{{ order.timestamp|time:"h:i A" }}</td>
                <!-- <td>{{ order.user.profile.user.username }}</td>
                <td>{{ order.user.profile.custom_user_id }}</td>
                <td>{{ order.user.profile.user.assigned_rm }}</td> -->
              </tr>
            </tbody>
          </table>
      </div>

      <div class="order-details-transaction">
        <h6 style="padding-top: 2%;">Client Details</h6>
       <table class="user-portfolio-toptable2">
            <thead class="user-portfolio-head-admin">
            <tr>
              <th>Name</th>
              <th>Custom User ID</th>
              <th>PAN Number</th>
              <th>Email</th>
              <th>Mobile Number</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>{{ order.user.profile.user.username }}</td>
              <td>{{ order.user.profile.custom_user_id }}</td>
              <td>{{ order.user.profile.pan_number }}</td>
              <td>{{ order.user.email }}</td>
              <td>{{ order.user.profile.mobile_number }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="order-details-transaction">
        <h6 style="padding-top: 2%;">Broker Details</h6>
        {% if cmr %}
         <table class="user-portfolio-toptable2">
            <thead class="user-portfolio-head-admin">
              <tr>
                <th>Broker Name</th>
                <th>Broker ID</th>
                <th>Client ID</th>
                <th>Broker PAN Number</th>
                <th>Broker Email</th>
                <th>Broker Contact</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>{{ cmr.broker.name }}</td>
                <td>{{ cmr.broker.broker_id }}</td>
                <td>{{ cmr.client_id_input }}</td>
                <td>{{ cmr.broker.pan }}</td>
                <td>{{ cmr.broker.email }}</td>
                <td>{{ cmr.broker.contact }}</td>
              </tr>
            </tbody>
          </table>
        {% else %}
          <p>No broker details found.</p>
        {% endif %}
      </div>

      <div class="order-details-transaction">
        <h6 style="padding-top: 2%;">Bank Account Details</h6>
        {% if bank_accounts %}
          <table class="user-portfolio-toptable2">
            <thead class="user-portfolio-head-admin">
              <tr>
                <th>Bank Name</th>
                <th>Account Holder Name</th>
                <th>Account Number</th>
                <th>IFSC Code</th>
                <th>Account Type</th>
              </tr>
            </thead>
            <tbody>
              {% for account in bank_accounts %}
              <tr>
                <td>{{ account.bank_name }}</td>
                <td>{{ account.account_holder_name }}</td>
                <td>{{ account.account_number }}</td>
                <td>{{ account.ifsc_code }}</td>
                <td>{{ account.account_type }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p>No bank account details found.</p>
        {% endif %}
      </div>

    <!-- bankaccount details end  -->

    <!-- Add Payment Button -->
    <div class="RMpaymentAddsection" style="padding-top: 2%;">
      <button class="RMpaymentAdd btn btn-primary" data-bs-toggle="modal" data-bs-target="#buyModal">Add Payment</button>
      <h6> Deal Value - {{ order.total_amount }}</h6>
      <h6> Remaining Amount - <span id="remainingAmount">{{ remaining_amount|floatformat:2 }}</span></h6>
    </div>

<!-- RM_User/templates/buyordersummeryRM.html -->
    <!-- Payment Records Table start -->
    <div class="order-details-transaction">
      <table class="user-portfolio-toptable2">
        <thead class="user-portfolio-head-admin">
          <tr>
            <th>SLNO</th>
            <th>Date</th>
            <th>Bank</th>
            <th>Amount Received</th>
            <th>Remaining Amount</th>
            <th>Upload Screenshot</th>
            <th>Remark</th>
            <th>RM Status</th>
            <th>AM Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for payment in rm_view.payment_records.all %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ payment.date|date:"d-m-Y" }}</td>
            <td>{{ payment.bank_name }}</td>
            <td>{{ payment.amount }}</td>
            <td>{{ payment.remaining_amount }}</td>
            <td>
              {% if payment.screenshot %}
                <a href="{{ payment.screenshot.url }}" target="_blank">üëÅÔ∏è‚Äçüó®Ô∏è</a>
              {% else %}
                N/A
              {% endif %}
            </td>
            <td>{{ payment.remark }}</td>
            <td>{{ payment.get_payment_status_display }}</td> 
            <td>{{ payment.get_AC_Payment_Status_display }}</td> 
            <td>
              <!-- Edit Button -->
              <button type="button"
                class="btn btn-sm btn-outline-primary"
                onclick='openPaymentEditModal({
                  id: {{ payment.id }},
                  bank_name: "{{ payment.bank_name }}",
                  amount: "{{ payment.amount }}",
                  remaining_amount: "{{ payment.remaining_amount }}",
                  remark: "{{ payment.remark }}",
                  payment_status: "{{ payment.payment_status }}",
                  paymentConfirmationMessage: "{{ payment.paymentConfirmationMessage|default_if_none:"" }}",
                  screenshot_url: "{% if payment.screenshot %}{{ payment.screenshot.url }}{% else %}#{% endif %}"
                })'>
                ‚úèÔ∏è 
              </button>


            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="10">No payment records found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <!-- Payment Modal Table end -->

    <!-- test 1234 start  -->
    <!-- Add/Edit Payment Modal Start-->
    <div class="order-details-transaction">
      <div class="modal fade" id="buyModal" tabindex="-1" aria-labelledby="buyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg-custom">
          <div class="modal-content custom-modal">
            <div class="modal-header">
              <h5 class="modal-title" id="buyModalLabel">Add/Edit Payment</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <form id="paymentForm" method="post" enctype="multipart/form-data" action="{% url 'RM_User:add_payment' order_id=order.order_id %}">
                {% csrf_token %}
                <div class="row g-3">

                  <!-- a) BANK -->
                  <div class="col-6">
                    <label class="form-label">Select Bank</label>
                    <select name="bank_name" class="form-select" required>
                      {% for bank in bank_accounts %}
                        <option value="{{ bank.bank_name }}">{{ bank.bank_name }}</option>
                      {% endfor %}
                    </select>
                  </div>

                  <!-- b) Remaining Amount -->
                  <div class="col-6">
                    <label class="form-label">Remaining Amount</label>
                    <input type="number" name="remaining_amount" class="form-control" step="0.01" value="{{ remaining_amount|floatformat:2 }}" readonly>
                  </div>

                  <!-- c) Status -->
                  <div class="col-6">
                    <label class="form-label">Status</label>
                    <select name="payment_status" class="form-select" required>
                      <option value="pending">Pending</option>
                      <option value="partial">Partial Payment</option>
                      <option value="approved">Payment Received</option>
                      <option value="rejected">Rejected</option> <!-- treat as "cancelled" -->
                    </select>
                  </div>

                  <!-- Enter Amount (editable only for partial; auto-filled for approved) -->
                  <div class="col-6">
                    <label class="form-label">Enter Amount</label>
                    <input type="number" name="amount" class="form-control" step="0.01" required>
                  </div>

                  <!-- Screenshot -->
                  <div class="col-6">
                    <label class="form-label">Upload Screenshot</label>
                    <input type="file" name="screenshot" class="form-control">
                    <a href="#" id="screenshotLink" target="_blank" style="display: none;">üîç View Existing</a>
                  </div>

                  <!-- Confirmation Message -->
                  <div class="col-6">
                    <label class="form-label">Payment Confirmation Message</label>
                    <input type="text" name="paymentConfirmationMessage" class="form-control">
                  </div>

                  <!-- Remark -->
                  <div class="col-12">
                    <label class="form-label">Remark</label>
                    <input type="text" name="remark" class="form-control">
                  </div>
                </div>

                <div class="modal-footer flex-column gap-2 mt-3">
                  <button type="submit" class="btn btn-success w-100" id="submitBtn">‚úîÔ∏è Submit</button>
                  <button type="button" class="btn btn-danger w-100" id="deleteBtn" style="display: none;">üóëÔ∏è Delete</button>
                </div>
              </form>
            </div>



          </div>
        </div>
      </div>
    </div>
    <!-- Add/Edit Payment Modal end-->




    <!-- Edit Status Modal start -->
    <div class="modal fade" id="transactionEditModal" tabindex="-1" aria-labelledby="transactionEditModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="transactionEditModalLabel">Edit Buy Transaction</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="transactionEditFormContainer">
            <div class="text-center">
              <span class="spinner-border"></span> Loading...
            </div>
          </div>
        </div>
      </div>
    </div>  
    <!-- Edit Status Modal end -->

<!-- RM_User/templates/buyordersummeryRM.html -->

  <!-- Order Transaction Details -->
    <div class="order-details-transaction">
      <h6 style="padding-top: 2%;">Order Transaction Details</h6>
        <table class="user-portfolio-toptable2">
          <thead class="user-portfolio-head-admin">
          <tr>
            <th>SLNO</th>
            <th>Broker</th>
            <th>ISIN Number</th>
            <th>Stock</th>
            <th>Order Type</th>
            <th>Share Price</th>
            <th>Buy Price</th>
            <th>Qty</th>
            <th>Deal Value</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in TransactionDetails %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ item.broker.name }}</td>
              <td>{{ item.stock.isin_no }}</td>
              <td>{{ item.stock.company_name }}</td>
              <td>{{ item.order_type }}</td>
              <td>{{ item.stock.share_price }}</td>
              <td>{{ item.price_per_share }}</td>
              <td>{{ item.quantity }}</td>
              <td>{{ item.total_amount }}</td>
              <!-- <td>{{ item.RM_status }}</td>
              <td>{{ item.get_RM_status_display }}</td> -->
              <td>{{ item.get_RM_status_display }}</td>


              <td>
                <!-- <a href="{% url 'RM_User:edit_transaction' item.id %}" class="btn btn-sm btn-outline-primary"> ‚úèÔ∏è</a> -->

                <button type="button"
                  class="btn btn-sm btn-outline-primary"
                  onclick='openTransactionEditModal({{ item.id }})'>
                  ‚úèÔ∏è
                </button>

                <!-- <a href="{% url 'RM_User:delete_transaction' pk=item.id %}"
                  onclick="return confirm('Are you sure you want to delete this transaction?');"
                  class="btn btn-danger btn-sm"
                  title="Delete Transaction"
                  aria-label="Delete Transaction">
                  üóëÔ∏è
                </a> -->



              </td>

            </tr>
          {% empty %}
            <tr>
              <td colspan="10" class="text-center">No transaction details available.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>

      <div class="RMpayment-process">

        <a href="{% url 'ST_User:buyDealLetterrST' %}?order_id={{ order.order_id }}" class="RMpayment-button">
                        Generate Provisional Deal Letter
        </a>

      </div>
    

    <!-- edit status form  -->
      <div class="modal fade" id="transactionEditModal" tabindex="-1" aria-labelledby="transactionEditModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="transactionEditModalLabel">Edit Buy Transaction</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="transactionEditFormContainer">
              <!-- Form will be loaded here by AJAX -->
              <div class="text-center">
                <span class="spinner-border"></span> Loading...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <p>No order details found.</p>
  {% endif %}


<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById('paymentForm');
  const submitBtn = document.getElementById('submitBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const screenshotLink = document.getElementById('screenshotLink');

  let mode = 'add'; // 'add' | 'edit'
  let currentPaymentId = null;

  function setActionForAdd() {
    form.action = "{% url 'RM_User:add_payment' order_id=order.order_id %}";
    mode = 'add';
    currentPaymentId = null;
    deleteBtn.style.display = 'none';
    submitBtn.innerText = '‚úîÔ∏è Submit';
  }

  function setActionForEdit(id) {
    form.action = `/RM_User/payment/edit/${id}/`;
    mode = 'edit';
    currentPaymentId = id;
    deleteBtn.style.display = 'inline-block';
    submitBtn.innerText = '‚úîÔ∏è Update';
  }

  function disableAllFields(disabled) {
    const controls = [
      'bank_name', 'amount', 'screenshot',
      'paymentConfirmationMessage', 'remark'
    ];
    controls.forEach(n => {
      const el = form.elements[n];
      if (el) el.disabled = disabled;
    });
  }

  function handleStatusChange() {
    const status = form.elements['payment_status'].value;
    const amountEl = form.elements['amount'];
    const remEl = form.elements['remaining_amount'];
    const bankEl = form.elements['bank_name'];
    const confirmEl = form.elements['paymentConfirmationMessage'];
    const remarkEl = form.elements['remark'];
    const fileEl = form.elements['screenshot'];

    // Always keep remaining readonly
    remEl.readOnly = true;

    // Reset disabled/readOnly before applying rules
    [amountEl, bankEl, confirmEl, remarkEl, fileEl].forEach(el => {
      el.disabled = false;
      if (el === amountEl) el.readOnly = false;
    });
    submitBtn.disabled = false;

    const remaining = parseFloat(remEl.value) || 0;

    if (status === 'pending') {
      // 2) Pending => submit disabled
      amountEl.value = '';
      submitBtn.disabled = true;
    } else if (status === 'approved') {
      // 3) Payment Received => take all remaining, lock amount
      amountEl.value = remaining.toFixed(2);
      amountEl.readOnly = true;
      submitBtn.disabled = false;
    } else if (status === 'partial') {
      // 3) Partial => amount editable
      amountEl.readOnly = false;
      submitBtn.disabled = false;
    } else if (status === 'rejected') {
      // 5) "cancelled" => disable all values (and prevent submit)
      amountEl.value = '';
      disableAllFields(true);
      submitBtn.disabled = true;
    }
  }

  function resetForm() {
    form.reset();
    screenshotLink.style.display = 'none';
    setActionForAdd();
    // default remaining from context
    form.elements['remaining_amount'].value = "{{ remaining_amount|floatformat:2 }}";
    handleStatusChange();
  }

  // Wire: Add Payment button
  document.querySelector('.RMpaymentAdd')?.addEventListener('click', () => {
    resetForm();
    const modal = new bootstrap.Modal(document.getElementById('buyModal'));
    modal.show();
  });

  // Expose to row "Edit" button
  window.openPaymentEditModal = function(payment) {
    setActionForEdit(payment.id);
    form.elements['bank_name'].value = payment.bank_name;
    form.elements['amount'].value = payment.amount || '';
    form.elements['remaining_amount'].value = payment.remaining_amount || "{{ remaining_amount|floatformat:2 }}";
    form.elements['payment_status'].value = payment.payment_status;
    form.elements['remark'].value = payment.remark || '';
    form.elements['paymentConfirmationMessage'].value = payment.paymentConfirmationMessage || '';

    if (payment.screenshot_url && payment.screenshot_url !== '#') {
      screenshotLink.href = payment.screenshot_url;
      screenshotLink.style.display = 'inline-block';
    } else {
      screenshotLink.style.display = 'none';
    }

    handleStatusChange();
    const modal = new bootstrap.Modal(document.getElementById('buyModal'));
    modal.show();
  };

  // Delete (4) ‚Äî only shown in edit mode
  deleteBtn.addEventListener('click', () => {
    if (!currentPaymentId) return;
    if (confirm('Are you sure you want to delete this payment record?')) {
      window.location.href = `/RM_User/payment/delete/${currentPaymentId}/`;
    }
  });

  // Status change listener
  form.elements['payment_status'].addEventListener('change', handleStatusChange);

  // Submit UX (no AJAX here; server will revalidate)
  form.addEventListener('submit', () => {
    submitBtn.disabled = true;
    submitBtn.innerText = mode === 'edit' ? 'Updating‚Ä¶' : 'Submitting‚Ä¶';
  });
});
</script>


<!-- status  Transfer to Accounts -->
<script>
  function openTransactionEditModal(id) {
    const container = document.getElementById('transactionEditFormContainer');
    container.innerHTML = '<div class="text-center"><span class="spinner-border"></span> Loading...</div>';

    fetch(`/RM_User/transaction/${id}/edit/ajax/`)
      .then(response => response.text())
      .then(html => {
        container.innerHTML = html;
        const modal = new bootstrap.Modal(document.getElementById('transactionEditModal'));
        modal.show();
      });
  }
</script>


<!-- delete payment -->
<script>
function confirmDelete() {
  if (confirm("Are you sure you want to delete this payment record?")) {
    if (currentEditingPaymentId) {
      window.location.href = `/RM_User/payment/delete/${currentEditingPaymentId}/`;
    }
  }
}
</script>
{% endblock %}
