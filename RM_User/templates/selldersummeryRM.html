{% extends "baseStructureRM.html" %}

{% block title %}Sell Order Summary{% endblock %}
{% block SubTitleRM %}Sell Order Summary{% endblock %}

{% block RMprofile_content %}
  {% if order %}
    
<div class="SMtable-head">
  <div class="order-details-transaction">
    <table class="user-portfolio-toptable2">
      <thead class="user-portfolio-head-admin">
        <tr>
          <th>Sl.no</th>
          <th>Order ID</th>
          <th>Date</th>
          <th>Time</th>
          <!-- <th>Client Name</th>
          <th>Client ID</th>
          <th>RM</th> -->
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>{{ order.id }}</td>
          <td>{{ order.order_id }}</td>
          <td>{{ order.timestamp|date:"d-m-Y" }}</td>
          <td>{{ order.timestamp|time:"h:i A" }}</td>
          <!-- <td>{{ order.user.profile.user.username }}</td>
          <td>{{ order.user.profile.custom_user_id }}</td>
          <td>{{ order.user.profile.user.assigned_rm }}</td> -->
        </tr>
      </tbody>
    </table>
    </div>
    <h6 style="padding-top: 2%;">Customer Details</h6>
    <div class="order-details-transaction">
      <table class="user-portfolio-toptable2">
      <thead class="user-portfolio-head-admin">
        <tr>
          <th>Name</th>
          <th>Custom User ID</th>
          <th>PAN Number</th>
          <th>Email</th>
          <th>Mobile Number</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>{{ order.user.profile.user.username }}</td>
          <td>{{ order.user.profile.custom_user_id }}</td>
          <td>{{ order.user.profile.pan_number }}</td>
          <td>{{ order.user.email }}</td>
          <td>{{ order.user.profile.mobile_number }}</td>
        </tr>
      </tbody>
    </table>
    </div>
    <h6 style="padding-top: 2%;">CMR Details</h6>
    {% if cmr %}
      <div class="order-details-transaction">
      <table class="user-portfolio-toptable2">
      <thead class="user-portfolio-head-admin">
          <tr>
            <th>Broker Name</th>
            <th>Broker ID</th>
            <th>Client ID</th>
            <th>Broker PAN Number</th>
            <th>Broker Email</th>
            <th>Broker Contact</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>{{ cmr.broker.name }}</td>
            <td>{{ cmr.broker.broker_id }}</td>
            <td>{{ cmr.client_id_input }}</td>
            <td>{{ cmr.broker.pan }}</td>
            <td>{{ cmr.broker.email }}</td>
            <td>{{ cmr.broker.contact }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    {% else %}
      <p>No broker details found.</p>
    {% endif %}

    <h6 style="padding-top: 2%;">Bank Account Details</h6>
    {% if bank_accounts %}
    <div class="order-details-transaction">
      <table class="user-portfolio-toptable2">
      <thead class="user-portfolio-head-admin">
          <tr>
            <th>Bank Name</th>
            <th>Account Holder Name</th>
            <th>Account Number</th>
            <th>IFSC Code</th>
            <th>Account Type</th>
          </tr>
        </thead>
        <tbody>
          {% for account in bank_accounts %}
          <tr>
            <td>{{ account.bank_name }}</td>
            <td>{{ account.account_holder_name }}</td>
            <td>{{ account.account_number }}</td>
            <td>{{ account.ifsc_code }}</td>
            <td>{{ account.account_type }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <p>No bank account details found.</p>
    {% endif %}

    <h6 style="padding-top: 2%;">Transaction Details</h6>
    <div class="order-details-transaction">
      <table class="user-portfolio-toptable2">
      <thead class="user-portfolio-head-admin">
        <tr>
          <th>SLNO</th>
          <th>Broker</th>
          <th>ISIN</th>
          <th>Stock</th>
          <th>Advisor Type</th>
          <th>Share Price</th>
          <th>Selling Price</th>
          <th>Qty</th>
          <th>Total Value</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for item in TransactionDetails %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ item.broker.name }}</td>
            <td>{{ item.stock.isin_no }}</td>
            <td>{{ item.stock.company_name }}</td>
            <td>
              {{ item.advisor.advisor_type|title }}
            </td>
            <td>{{ item.stock.share_price }}</td>
            <td>{{ item.selling_price }}</td>
            <td>{{ item.quantity }}</td>
            <td>{{ item.total_value }}</td>
            <td>{{ item.get_RM_status_display }}</td>
            <td>
              <!-- <a href="{% url 'RM_User:edit_sell_transaction' item.id %}" class="btn btn-sm btn-outline-primary">✏️</a> -->

              <button type="button"
                class="btn btn-sm btn-outline-warning"
                onclick='openSellTransactionEditModal({{ item.id }})'>
                ✏️
              </button>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="11">No records found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
    <div class="RMpayment-process">
      <h4><strong>Total Amount: </strong> {{ order.total_value }}</h4>
      <a href="{% url 'ST_User:sellDealLetterrST' %}?order_id={{ order.order_id }}" class="RMpayment-button">
                          Generate Provisional Deal Letter
        </a>
    </div>


    <!-- edit status form  -->
    <div class="modal fade" id="transactionEditModal" tabindex="-1" aria-labelledby="transactionEditModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="transactionEditModalLabel">Edit Sell Transaction</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="transactionEditFormContainer">
            <!-- Form will be loaded here by AJAX -->
            <div class="text-center">
              <span class="spinner-border"></span> Loading...
            </div>
          </div>
        </div>
      </div>
    </div>

    {% else %}
      <p>No order details found.</p>
    {% endif %}

<!-- Edit Sell Transaction -->
<script>
function openSellTransactionEditModal(id) {
  const container = document.getElementById('transactionEditFormContainer');
  container.innerHTML = '<div class="text-center"><span class="spinner-border"></span> Loading...</div>';

  fetch(`/RM_User/sell-transaction/${id}/edit/ajax/`)
    .then(response => response.text())
    .then(html => {
      container.innerHTML = html;
      const modal = new bootstrap.Modal(document.getElementById('transactionEditModal'));
      modal.show();
    });
}
</script>

{% endblock %}
