<!-- templates/accounts/profileSidebar.html -->
{% load sidebar_tags %}

<!-- Sidebar -->
<div style="width: 35%; border-radius: 12px; padding: 15px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center;">
  <div class="profile-sidebar mb-3" style="font-family: Arial, sans-serif; padding: 10px;">
    <div style="width: 450px; border-radius: 8px; margin: 0 auto;">

      <!-- Tabs -->
      <div style="display: flex; justify-content: space-between; align-items: center; background-color: #2e3a59; padding: 10px; font-size: 14px;">
        <div style="display: flex; gap: 6px;">
          {% for group in groups %}
            <a href="?group={{ group.id }}"
              style="padding: 4px 8px; border-radius: 4px; text-decoration: none; background-color: #2e7bb4; color: white;
              {% if request.GET.group|default:'' == group.id|stringformat:'s' %}border-bottom: 2px solid #60d394;{% endif %}"
              onmouseover="this.style.borderBottom='2px solid #60d394';"
              onmouseout="if('{{ request.GET.group|default:'' }}' != '{{ group.id }}') this.style.borderBottom='none';">
              {{ group.name }} |
            </a>
          {% endfor %}
        </div>

        <div style="display: flex; gap: 12px;">
          <a href="?unlisted=1"
            style="padding: 4px 8px; text-decoration: none;
            {% if show_all_unlisted %}color: #60d394; border-bottom: 2px solid #60d394;{% else %}color: white;{% endif %}"
            onmouseover="this.style.borderBottom='2px solid #60d394';"
            onmouseout="if (!{{ show_all_unlisted|yesno:'true,false' }}) this.style.borderBottom='none';">
            Unlisted |
          </a>

          <a href="?angel=1"
            style="padding: 4px 8px; text-decoration: none;
            {% if show_all_angel %}color: #60d394; border-bottom: 2px solid #60d394;{% else %}color: white;{% endif %}"
            onmouseover="this.style.borderBottom='2px solid #60d394';"
            onmouseout="if (!{{ show_all_angel|yesno:'true,false' }}) this.style.borderBottom='none';">
            Angel Invest
          </a>
        </div>
      </div>

      <!-- Search Bar -->
      <div style="background-color: #3a456d; padding: 8px 12px;">
        <form method="get" style="display: flex;">
        {% if show_all_unlisted %}
            <input type="hidden" name="unlisted" value="1">
        {% elif show_all_angel %}
            <input type="hidden" name="angel" value="1">
        {% elif request.GET.group %}
            <input type="hidden" name="group" value="{{ request.GET.group }}">
        {% endif %}
        
        <input type="text" name="search" value="{{ search_query }}" placeholder="Search by company or scrip name"
            style="flex: 1; padding: 6px 10px; border: none; background-color: transparent; color: white; font-size: 14px; outline: none;">
        <button type="submit" style="background: none; border: none; cursor: pointer; padding: 0 8px;" title="Search">
            <span style="color: white; font-size: 18px;">&#128269;</span>
        </button>
        </form>

      </div>

      <!-- Stock List -->
      <div style="max-height: 700px; overflow-y: auto;">
        {% for stock in stock_list %}
          <div style="background-color: #dee7f2; padding: 10px; margin-bottom: 5px; border-radius: 6px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="font-weight: bold;">
                {{ stock.company_name }}
                <div style="display: inline-flex; align-items: center; gap: 4px; margin-left: 8px;">
                  {% if stock.in_group %}
                    <form method="POST" action="{% url 'unlisted_stock_marketplace:remove_from_group' stock.wishlist_id %}" style="display: inline;">
                        {% csrf_token %}
                        <span style="background-color: #999; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">
                        Group {{ stock.group_number }}
                        </span>
                        <button type="submit" title="Remove from Group"
                        style="margin-left: 6px; background-color: #e74c3c; color: white; border: none; padding: 2px 6px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                        Remove âœ–
                        </button>
                    </form>

                  {% else %}
                    <button class="stock-btn yellow-btn wishlist-btn wishlist"
                      data-stock-id="{{ stock.id }}"
                      data-stock-name="{{ stock.company_name }}"
                      data-url="{% url 'unlisted_stock_marketplace:get_next_wishlist_group_name' %}"
                      style="padding: 2px 6px; border-radius: 4px; border: none; font-size: 12px; background-color: #f7c948;">
                      Wishlist ðŸ›’
                    </button>
                  {% endif %}

                  <span title="Buy {{ stock.company_name }}"
                      onclick='openBuyModal(
                        "{{ stock.id }}",
                        "{{ stock.company_name|escapejs }}",
                        "{{ stock.share_price }}",
                        "{{ stock.quantity }}",
                        "{% url 'user_portfolio:buy_stock' stock.id %}"
                      )' style="background-color: #49c5b6; color: white; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 12px;">B</span>

                  <span onclick='openSellModal(
                      "{{ stock.id }}",
                      "{{ stock.company_name|escapejs }}",
                      "{{ stock.share_price }}",
                      "{{ stock.quantity }}",
                      "{% url 'user_portfolio:sell_stock' stock.id %}"
                    )' style="background-color: #a8575b; color: white; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 12px;">S</span>
                        </div>

              </div>

              <div style="color: {% if stock.profit %}green{% else %}red{% endif %}; font-weight: bold;">
                â‚¹{{ stock.share_price }}
              </div>
            </div>

            <div style="text-align: right; font-size: 12px; color: #333;">
              â‚¹{{ stock.profit }} {{ stock.profit_percentage }}%
            </div>
          </div>
        {% empty %}
          <p style="color: white; text-align: center;">No stocks found.</p>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Wishlist Modal -->
<div id="wishlistModal" class="wishlist-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);">
  <div class="wishlist-modal-content" style="background-color: #fff; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 400px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative;">
    <span class="close" onclick="document.getElementById('wishlistModal').style.display='none'" style="position: absolute; top: 10px; right: 15px; font-size: 24px; font-weight: bold; color: #aaa; cursor: pointer;">&times;</span>
    <h3 style="margin-top: 0; font-size: 20px; color: #333;">Confirm Wishlist</h3>
    <p style="font-size: 16px; color: #555;">You're about to add <strong id="stockName" style="color: #000;"></strong> to <strong id="wishlistGroupName" style="color: #000;"></strong>.</p>
    <form id="wishlistForm" method="POST" action="{% url 'unlisted_stock_marketplace:add_to_wishlist' %}" style="margin-top: 20px;">
      {% csrf_token %}
      <input type="hidden" name="stock_id" id="stockIdInput">
      <input type="hidden" name="custom_list_name" id="customListName">
      <button type="submit" class="stock-btn yellow-btn" style="background-color: #f7c948; color: #000; border: none; padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; width: 100%;">Confirm Add</button>
    </form>
  </div>
</div>

<div id="popup-message" style="display: none; background-color: #333; color: white; padding: 10px 20px; position: fixed; top: 20px; right: 20px; border-radius: 8px; z-index: 1100;"></div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const wishlistBtns = document.querySelectorAll(".wishlist-btn");
    const modal = document.getElementById("wishlistModal");
    const stockNameDisplay = document.getElementById("stockName");
    const wishlistGroupName = document.getElementById("wishlistGroupName");
    const stockIdInput = document.getElementById("stockIdInput");
    const customListName = document.getElementById("customListName");

    wishlistBtns.forEach(btn => {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        const stockId = this.dataset.stockId;
        const stockName = this.dataset.stockName;
        const fetchUrl = this.dataset.url + `?stock_id=${stockId}`;
        fetch(fetchUrl)
          .then(res => res.json())
          .then(data => {
            stockNameDisplay.textContent = stockName;
            wishlistGroupName.textContent = data.group_name;
            stockIdInput.value = stockId;
            customListName.value = data.group_name;
            modal.style.display = "block";
          });
      });
    });

    window.addEventListener("click", (e) => {
      if (e.target === modal) modal.style.display = "none";
    });
  });

  function showPopupMessage(message) {
    const popup = document.getElementById("popup-message");
    popup.innerText = message;
    popup.style.display = "block";
    setTimeout(() => popup.style.display = "none", 3000);
  }

  {% get_and_clear_popup_message as popup_message %}
  {% if popup_message %}
    showPopupMessage("{{ popup_message }}");
  {% endif %}
</script>
