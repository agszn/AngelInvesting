<!-- templates/accounts/profileSidebar.html -->
{% load sidebar_tags %}
{% load static%}

<!-- New Sidebar -->
<div class="user-sidebar" id="userSidebar">
  <div class="user-sidebar-top-logo">
    <a href="/"><img src="{% static 'Media/images/thangivelogodashboard.png' %}" alt="logo"></a>
  </div>

  <div class="user-group-tap">
    <div class="user-number-group">
      {% for group in groups %}
        <a href="?group={{ group.id }}" class="{% if group.id == current_group_id %}active{% endif %}">
          {{ group.name }}
        </a>
      {% endfor %}
    </div>
    <div class="user-name-group">
      <div>
        <a href="?unlisted=1" class="{% if show_all_unlisted %}active{% endif %}">Unlisted</a> |
        <a href="?angel=1" class="{% if show_all_angel %}active{% endif %}">Angel Invest</a>
      </div>
    </div>
  </div>

  <!-- Search -->
  <div class="user-serach-bar">
    <input
      type="text"
      id="sidebarSearchInput"
      placeholder="Search Stocks..."
      autocomplete="off"
      style="background-color: white;color: #000; width: 100%; border-radius: 5px;"
    >
  </div>

  <!-- Stock list (server-rendered partial) -->
  <div id="stockListContainer">
    {% include 'accounts/includes/sidebar_stock_list.html' %}
  </div>
</div>

<script>
  /* ---------------- Cookie helpers + sidebar toggle ---------------- */
  function setCookie(name, value, hours) {
    let expires = "";
    if (hours) {
      const date = new Date();
      date.setTime(date.getTime() + (hours * 60 * 60 * 1000));
      expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "") + expires + "; path=/";
  }

  function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
      let c = ca[i];
      while (c.charAt(0) === ' ') c = c.substring(1);
      if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
  }

  function toggleSidebar() 
  {
    const sidebar = document.getElementById('userSidebar');
    const mainContent = document.querySelector('.user-main-content');
    const isCollapsed = sidebar.classList.toggle('collapsed');
    if (mainContent) mainContent.classList.toggle('collapsed');
    setCookie("sidebarState", isCollapsed ? "collapsed" : "expanded", 1);
  }

  document.addEventListener('DOMContentLoaded', function () {
    const sidebar = document.getElementById('userSidebar');
    const mainContent = document.querySelector('.user-main-content');
    const sidebarState = getCookie("sidebarState");

    if (sidebarState) 
    {
      const collapsed = sidebarState === "collapsed";
      sidebar.classList.toggle('collapsed', collapsed);
      if (mainContent) mainContent.classList.toggle('collapsed', collapsed);
    } else 
    {
      if (window.innerWidth < 768) {
        sidebar.classList.add('collapsed');
        if (mainContent) mainContent.classList.add('collapsed');
        setCookie("sidebarState", "collapsed", 1);
      }
    }

    window.addEventListener('resize', function () {
      if (!getCookie("sidebarState")) {
        if (window.innerWidth < 768) {
          sidebar.classList.add('collapsed');
          if (mainContent) mainContent.classList.add('collapsed');
        } else {
          sidebar.classList.remove('collapsed');
          if (mainContent) mainContent.classList.remove('collapsed');
        }
      }
    });
  });
</script>

<!-- Wishlist Modal -->
<div id="wishlistModal" class="wishlist-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);">
  <div class="wishlist-modal-content" style="background-color: #fff; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 400px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative;">
    <span class="close" onclick="document.getElementById('wishlistModal').style.display='none'" style="position: absolute; top: 10px; right: 15px; font-size: 24px; font-weight: bold; color: #aaa; cursor: pointer;">&times;</span>

    <!-- Keep simple text; group name is optional -->
    <p style="font-size: 16px; color: #555;">
      <strong id="stockName" style="color: #000;"></strong>
      <!-- Optional: uncomment to display suggested group name -->
      <!-- <span id="wishlistGroupName" style="color:#000;"></span> -->
    </p>

    <form id="wishlistForm" method="POST" action="{% url 'unlisted_stock_marketplace:add_to_wishlist' %}" style="margin-top: 20px;">
      {% csrf_token %}
      <input type="hidden" name="stock_id" id="stockIdInput">
      <input type="hidden" name="custom_list_name" id="customListName">
      <button type="submit" class="stock-btn yellow-btn" style="background-color: #61C46E; color: #000; border: none; padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; width: 100%;">Confirm Add</button>
    </form>
  </div>
</div>

<div id="popup-message" style="display: none; background-color: #333; color: white; padding: 10px 20px; position: fixed; top: 20px; right: 20px; border-radius: 8px; z-index: 1100;"></div>

<script>
  /* ---------------- Wishlist: event delegation (works after search updates) ---------------- */
  document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("wishlistModal");
    const stockNameDisplay = document.getElementById("stockName");
    const wishlistGroupName = document.getElementById("wishlistGroupName"); // may be null (optional element)
    const stockIdInput = document.getElementById("stockIdInput");
    const customListName = document.getElementById("customListName");
    const stockListContainer = document.getElementById("stockListContainer");

    // Delegate clicks from stock list to any current/future `.wishlist-btn`
    stockListContainer.addEventListener("click", function (e) {
      const btn = e.target.closest(".wishlist-btn");
      if (!btn) return;

      e.preventDefault();

      const stockId = btn.dataset.stockId;
      const stockName = btn.dataset.stockName;
      const fetchUrl = btn.dataset.url ? (btn.dataset.url + `?stock_id=${encodeURIComponent(stockId)}`) : null;

      // If API for suggested group exists, fetch it; otherwise open modal directly
      if (fetchUrl) {
        fetch(fetchUrl)
          .then(res => res.ok ? res.json() : Promise.reject())
          .then(data => {
            stockNameDisplay.textContent = stockName || "";
            if (wishlistGroupName) wishlistGroupName.textContent = data.group_name || "";
            stockIdInput.value = stockId || "";
            customListName.value = data.group_name || "";
            modal.style.display = "block";
          })
          .catch(() => {
            // fallback open without group suggestion
            stockNameDisplay.textContent = stockName || "";
            if (wishlistGroupName) wishlistGroupName.textContent = "";
            stockIdInput.value = stockId || "";
            customListName.value = "";
            modal.style.display = "block";
          });
      } else {
        stockNameDisplay.textContent = stockName || "";
        if (wishlistGroupName) wishlistGroupName.textContent = "";
        stockIdInput.value = stockId || "";
        customListName.value = "";
        modal.style.display = "block";
      }
    });

    // Close modal on backdrop click or ESC
    window.addEventListener("click", (e) => {
      if (e.target === modal) modal.style.display = "none";
    });
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") modal.style.display = "none";
    });
  });

  /* ---------------- Simple toast ---------------- */
  function showPopupMessage(message) {
    const popup = document.getElementById("popup-message");
    popup.innerText = message;
    popup.style.display = "block";
    setTimeout(() => popup.style.display = "none", 3000);
  }

  {% get_and_clear_popup_message as popup_message %}
  {% if popup_message %}
    showPopupMessage("{{ popup_message }}");
  {% endif %}
</script>

<script>
  /* ---------------- Search (kept) ---------------- */
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("sidebarSearchInput");
    const stockListContainer = document.getElementById("stockListContainer");
    let typingTimer;
    const delay = 300;

    searchInput.addEventListener("input", function () {
      clearTimeout(typingTimer);
      typingTimer = setTimeout(performSearch, delay);
    });

    function performSearch() {
      const query = searchInput.value || "";
      const params = new URLSearchParams(window.location.search);
      params.set("sidebar_search", query);

      const ajaxUrl = "{% url 'user_portfolio:ajax_filtered_stocks' %}";
      fetch(`${ajaxUrl}?${params.toString()}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      })
        .then(res => res.ok ? res.json() : Promise.reject())
        .then(data => {
          stockListContainer.innerHTML = data.html;
          // No need to re-bind wishlist button handlers â€” event delegation above handles it.
        })
        .catch(() => {
          // Optional: show a small error toast
          // showPopupMessage("Search failed. Please try again.");
        });
    }
  });
</script>
