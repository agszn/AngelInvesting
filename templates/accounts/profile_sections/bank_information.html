<!-- bank details -->
<div class="user-personal_Information">
    <div class="user-personal_Information-label">
        <div>Bank Account Details</div>
        <button onclick="openBankModal('add')" class="add-button">‚ûï Add Bank</button>
    </div>
    <div class="user-personal_Information-feilds">
        <div class="profile-container">
            {% if bank_accounts %}
                {% for account in bank_accounts %}
                    <div class="heading-feilds"><span>Account Holder Name</span>{{ account.account_holder_name }}</div>
                    <div class="heading-feilds"><span>Bank Name</span>{{ account.bank_name }}</div>
                    <div class="heading-feilds"><span>Account Type</span>{{ account.account_type }}</div>
                    <div class="heading-feilds"><span>Account Number</span>{{ account.account_number }}</div>
                    <div class="heading-feilds"><span>IFSC Code</span>{{ account.ifsc_code }}</div>
                    <div class="heading-feilds"><span>Account Status</span>{{ account.account_status|capfirst }}</div>

                    {% if account.linked_phone_number %}
                        <div class="heading-feilds"><span>Linked Phone Number</span>{{ account.linked_phone_number }}</div>
                    {% endif %}

                    {% if account.bankDetails_doc_password %}
                        <div class="heading-feilds"><span>Document Password</span> {{ account.bankDetails_doc_password }}</div>
                    {% endif %}

                    {% if account.statementPaper %}
                        <div class="heading-feilds">
                            <span>Statement Paper</span>
                            <a href="{{ account.statementPaper.url }}" target="_blank" class="download-link">üìÑ Download</a>
                        </div>
                    {% endif %}
                    
                    <div class="heading-feilds1">
                        <button 
                            onclick="editBank(
                                {{ account.id }},
                                '{{ account.account_holder_name }}',
                                '{{ account.bank_name }}',
                                '{{ account.account_type }}',
                                '{{ account.account_number }}',
                                '{{ account.ifsc_code }}',
                                '{{ account.account_status }}',
                                '{{ account.linked_phone_number|default:'' }}',
                                '{{ account.bankDetails_doc_password|default:'' }}',
                                '{{ account.document_type|default:'' }}'
                              )"

                            class="edit-bank-button">
                            ‚úèÔ∏è Edit
                        </button>
                        <form method="POST" action="{% url 'delete_bank_account' account.id %}" 
                            style="display:inline;" 
                            onsubmit="return confirm('Are you sure you want to delete this Bank Account Detail?');">
                            {% csrf_token %}
                            <button type="submit" class="delete-bank-button">üóë Delete</button>
                        </form>
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-data-message">No bank accounts added yet.</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- --- styles for field-level errors --- -->
<style>
  .input-invalid { border-color: #dc2626 !important; outline: none; }
  .field-error { color:#dc2626; font-size:.85rem; margin-top:6px; }
</style>

<!-- ===================== BANK MODAL ===================== -->
<div id="bank_modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,.5); justify-content:center;">
  <div style="width:750px; background:#0E213F; border-radius:10px; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,.1); max-height:70vh; overflow-y:auto;">
    <div style="margin:auto; background:#f9f9f9; padding:25px; border-radius:12px; box-shadow:0 0 10px rgba(0,0,0,.05);">

      <!-- Header -->
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 id="modal_title" style="margin:0; color:#2c3e50;">Bank Account Details</h3>
        <div>
          <button type="button" onclick="submitBankForm()" style="background:#e5f9e7; color:green; border:none; padding:6px 14px; border-radius:20px; font-weight:bold; cursor:pointer; margin-right:8px;">‚úî Save</button>
          <button type="button" onclick="closeBankModal()" style="background:#ffe5e5; color:red; border:none; padding:6px 14px; border-radius:20px; font-weight:bold; cursor:pointer;">‚ùå Close</button>
        </div>
      </div>

      <!-- Form -->
      <form id="bank_form" method="POST" action="{% url 'save_bank_account' %}" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        <input type="hidden" id="account_id" name="account_id" value="">

        <div style="display:flex; flex-wrap:wrap; gap:20px; margin-top:20px;">

          <!-- Holder -->
          <div style="flex:1; min-width:250px;">
            <label style="font-weight:bold;">Account Holder Name</label>
            <input id="holder_name" name="account_holder_name" type="text" maxlength="100" required
              placeholder="Enter name" style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
            <div class="field-error" id="err_account_holder_name"></div>
          </div>

          <!-- Bank -->
          <div style="flex:1; min-width:250px;">
            <label style="font-weight:bold;">Bank Name</label>
            <input id="bank_name" name="bank_name" type="text" maxlength="100" required
              placeholder="Enter bank name" style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
            <div class="field-error" id="err_bank_name"></div>
          </div>

          <!-- Type -->
          <div style="flex:1; min-width:250px;">
            <label style="font-weight:bold;">Account Type</label>
            <select id="account_type" name="account_type" required
              style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
              <option value="">Select Account Type</option>
              <option value="saving">Saving</option>
              <option value="current">Current</option>
              <option value="salary">Salary</option>
              <option value="nre">NRE</option>
              <option value="nro">NRO</option>
            </select>
            <div class="field-error" id="err_account_type"></div>
          </div>

          <!-- Number -->
          <div style="flex:1; min-width:250px;">
            <label style="font-weight:bold;">Account Number</label>
            <input id="account_number" name="account_number" type="text" maxlength="30" required
              placeholder="Enter account number" style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
            <div class="field-error" id="err_account_number"></div>
          </div>

          <!-- IFSC -->
          <div style="flex:1; min-width:250px;">
            <label style="font-weight:bold;">IFSC Code</label>
            <input id="ifsc_code" name="ifsc_code" type="text" required
              placeholder="Enter IFSC" pattern="[A-Z]{4}0[A-Z0-9]{6}"
              title="Enter valid IFSC (e.g., SBIN0001234)"
              style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
            <div class="field-error" id="err_ifsc_code"></div>
          </div>

          <!-- Status -->
          <div style="flex:1; min-width:250px;">
            <label style="font-weight:bold;">Account Status</label>
            <select id="account_status" name="account_status"
              style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
              <option value="active" selected>Active</option>
              <option value="inactive">Inactive</option>
              <option value="closed">Closed</option>
            </select>
            <div class="field-error" id="err_account_status"></div>
          </div>

          <!-- Linked Phone -->
          <div style="flex:1; min-width:250px;">
            <label style="font-weight:bold;">Linked Phone Number (Optional)</label>
            <input id="linked_phone_number" name="linked_phone_number" type="text"
              placeholder="Enter linked phone number" pattern="^\+?\d{10,12}$"
              style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
            <div class="field-error" id="err_linked_phone_number"></div>
          </div>

          <!-- Document Type -->
          <div style="flex:1; min-width:250px;">
            <label style="font-weight:bold;">Document Type</label>
            <select id="document_type" name="document_type" required
              style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;"
              onchange="toggleDocPassword()">
              <option value="">Select Document Type</option>
              <option value="cancelled_cheque">Cancelled Cheque</option>
              <option value="bank_statement">One Month Bank Statement</option>
              <option value="passbook">Front Page of Passbook</option>
            </select>
            <div class="field-error" id="err_document_type"></div>
          </div>


          <!-- Statement -->
          <div style="flex:1; min-width:250px;">
            <label style="font-weight:bold;">Statement Paper (PDF/XLSX)</label>
            <input id="statementPaper" name="statementPaper" type="file" accept=".pdf,.xlsx"
              style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
            <div class="field-error" id="err_statementPaper"></div>
          </div>
        </div>

          <!-- Doc password (conditional) -->
          <div style="flex:1; min-width:250px; display:none;" id="doc_password_wrapper">
            <label style="font-weight:bold;">Document Password (Optional)</label>
            <input id="doc_password" name="bankDetails_doc_password" type="text"
              placeholder="Enter document password"
              style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
            <div class="field-error" id="err_bankDetails_doc_password"></div>
          </div>

      </form>

      <!-- Error summary (optional) -->
      <div id="bank_error_summary" class="field-error" style="margin-top:12px;"></div>

      <!-- JSON from server for errors + posted values -->
      {% if bank_form_errors %}{{ bank_form_errors|json_script:"bank-errors" }}{% endif %}
      {% if bank_form_post %}{{ bank_form_post|json_script:"bank-post" }}{% endif %}
      {% if open_bank_modal %}<span id="open-bank-flag" hidden></span>{% endif %}

    </div>
  </div>
</div>

<!-- ===================== JS ===================== -->
<script>
  function closeOtherModals(keepId) {
    // hide any other modals if present (e.g., edit profile)
    const all = document.querySelectorAll('[id$="_modal"], .modal, [role="dialog"]');
    all.forEach(el => { if (el.id !== keepId) el.style.display = 'none'; });
  }

  function openBankModal(mode) {
    closeOtherModals('bank_modal');
    const modal = document.getElementById('bank_modal');
    modal.style.display = 'flex';
    document.getElementById('modal_title').textContent = mode === 'add' ? 'Bank Account Details' : 'Bank Account Details';
    if (mode === 'add') {
      document.getElementById('bank_form').reset();
      document.getElementById('account_id').value = '';
      document.getElementById('account_status').value = 'active';
    }
  }

  function closeBankModal() {
    document.getElementById('bank_modal').style.display = 'none';
  }

  function submitBankForm() {
    // Use HTML5 validation first, then submit
    const form = document.getElementById('bank_form');
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }
    form.submit();
  }

  function toggleDocPassword() {
    const docType = document.getElementById('document_type').value;
    const wrapper = document.getElementById('doc_password_wrapper');

    if (docType === 'bank_statement') {
      wrapper.style.display = 'block';
    } else {
      wrapper.style.display = 'none';
      document.getElementById('doc_password').value = '';
    }
  }

  function editBank(id, holder, bank, type, number, ifsc, status, linkedPhone, docPassword, docType) {
    openBankModal('edit');
    document.getElementById('account_id').value = id;
    document.getElementById('holder_name').value = holder;
    document.getElementById('bank_name').value = bank;
    document.getElementById('account_type').value = type;
    document.getElementById('account_number').value = number;
    document.getElementById('ifsc_code').value = ifsc;
    document.getElementById('account_status').value = status || 'active';
    document.getElementById('linked_phone_number').value = linkedPhone || '';
    document.getElementById('doc_password').value = docPassword || '';
    document.getElementById('document_type').value = docType || '';
    toggleDocPassword();
  }


  // ---- helpers to apply server-side errors to fields ----
  function setFieldError(name, messages) {
    const input = document.getElementById(name) || document.querySelector(`[name="${name}"]`);
    const errBox = document.getElementById(`err_${name}`);
    if (!input || !errBox) return;

    const msg = (messages && messages.length) ? (messages[0].message || messages[0]) : '';
    if (msg) {
      input.classList.add('input-invalid');
      input.setAttribute('aria-invalid', 'true');
      errBox.textContent = msg;
    } else {
      input.classList.remove('input-invalid');
      input.removeAttribute('aria-invalid');
      errBox.textContent = '';
    }
  }

  function populatePostedValues(post) {
    if (!post) return;
    const map = {
      account_id: 'account_id',
      account_holder_name: 'holder_name',
      bank_name: 'bank_name',
      account_type: 'account_type',
      account_number: 'account_number',
      ifsc_code: 'ifsc_code',
      account_status: 'account_status',
      linked_phone_number: 'linked_phone_number',
      bankDetails_doc_password: 'doc_password'
    };
    Object.entries(map).forEach(([postKey, id]) => {
      if (post[postKey] !== undefined) {
        const el = document.getElementById(id);
        if (el) el.value = post[postKey];
      }
    });
  }

  (function initBankModalFromServer() {
    const openFlag = document.getElementById('open-bank-flag');
    const errScript = document.getElementById('bank-errors');
    const postScript = document.getElementById('bank-post');

    if (!openFlag && !errScript) return;

    // ensure only Bank modal is open
    openBankModal('edit');

    // populate posted values
    let post = {};
    if (postScript) {
      try { post = JSON.parse(postScript.textContent); } catch(e) {}
      populatePostedValues(post);
    }

    // apply field errors
    let errs = {};
    if (errScript) {
      try { errs = JSON.parse(errScript.textContent); } catch(e) {}
      const fields = [
        'account_holder_name','bank_name','account_type','account_number',
        'ifsc_code','account_status','linked_phone_number','bankDetails_doc_password',
        'document_type','statementPaper'
      ];
      let firstInvalid = null;
      fields.forEach(f => {
      const idMap = {
        account_holder_name:'holder_name',
        bank_name:'bank_name',
        account_type:'account_type',
        account_number:'account_number',
        ifsc_code:'ifsc_code',
        account_status:'account_status',
        linked_phone_number:'linked_phone_number',
        bankDetails_doc_password:'doc_password',
        document_type:'document_type',
        statementPaper:'statementPaper'
      };
        const msgList = errs[f];
        setFieldError(idMap[f], msgList);
        if (!firstInvalid && msgList && msgList.length) {
          firstInvalid = document.getElementById(idMap[f]);
        }
      });

      // error summary (optional)
      const summary = document.getElementById('bank_error_summary');
      if (summary) {
        const lines = [];
        Object.keys(errs).forEach(k => {
          const arr = errs[k] || [];
          arr.forEach(o => lines.push(typeof o === 'string' ? o : (o.message || 'Invalid value')));
        });
        summary.textContent = lines.join(' ‚Ä¢ ');
      }

      // focus the first invalid field
      if (firstInvalid) {
        firstInvalid.focus({preventScroll:true});
        firstInvalid.scrollIntoView({behavior:'smooth', block:'center'});
      }
    }
  })();
</script>
