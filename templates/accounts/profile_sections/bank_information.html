<!-- bank details -->
<div class="user-personal_Information">
  <div class="user-personal_Information-label">
      <div>Bank Account Details</div>
      <button onclick="openBankModal('add')" class="add-button">‚ûï Add Bank</button>
  </div>
  <hr>
  <div class="user-personal_Information-feilds">
      <div class="profile-containerBank">
          {% if bank_accounts %}
              {% for account in bank_accounts %}
              <div class="bank-account-card">
                  <div class="heading-feilds">Account Holder Name<span>{{ account.account_holder_name }}</span></div>
                  <div class="heading-feilds">Bank Name<span>{{ account.bank_name }}</span></div>
                  <div class="heading-feilds">Account Type<span>{{ account.get_account_type_display|default:account.account_type }}</span></div>
                  <div class="heading-feilds">Account Number<span>{{ account.account_number }}</span></div>
                  <div class="heading-feilds">IFSC Code<span>{{ account.ifsc_code }}</span></div>
                  <div class="heading-feilds">Account Status<span>{{ account.account_status|capfirst }}</span></div>

                  {% if account.linked_phone_number %}
                      <div class="heading-feilds">Linked Phone Number<span>{{ account.linked_phone_number }}</span></div>
                  {% endif %}

                  {% if account.bankDetails_doc_password %}
                      <div class="heading-feilds">Document Password<span>{{ account.bankDetails_doc_password }}</span></div>
                  {% endif %}

                  {% if account.statementPaper %}
                      <div class="heading-feilds">
                          Statement Paper
                          <span><a href="{{ account.statementPaper.url }}" target="_blank" class="download-link">üìÑ Download</a></span>
                      </div>
                  {% endif %}
                  
                  <div class="bank-account-actions">
                      <button 
                          onclick="editBank(
                              {{ account.id }},
                              '{{ account.account_holder_name }}',
                              '{{ account.bank_name }}',
                              '{{ account.account_type }}',
                              '{{ account.account_number }}',
                              '{{ account.ifsc_code }}',
                              '{{ account.account_status }}',
                              '{{ account.linked_phone_number|default:'' }}',
                              '{{ account.bankDetails_doc_password|default:'' }}',
                              '{{ account.document_type|default:'' }}'
                            )"
                          class="edit-bank-button">
                          ‚úèÔ∏è Edit
                      </button>
                      <form method="POST" action="{% url 'delete_bank_account' account.id %}" 
                          style="display:inline;" 
                          onsubmit="return confirm('Are you sure you want to delete this Bank Account Detail?');">
                          {% csrf_token %}
                          <button type="submit" class="delete-bank-button">üóë Delete</button>
                      </form>
                  </div>
              </div>
              <hr/>
              {% endfor %}
          {% else %}
              <div class="no-data-message">No bank accounts added yet.</div>
          {% endif %}
      </div>
  </div>
</div>

<!-- --- styles for field-level errors --- -->
<style>
  .input-invalid { border-color: #dc2626 !important; outline: none; }
  .field-error { color:#dc2626; font-size:.85rem; margin-top:6px; }
  .text-muted { color:#6b7280; font-size: .82rem; display:block; margin-top:4px; }
</style>

<!-- ===================== BANK MODAL ===================== -->
<div id="bank_modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,.5); justify-content:center;">
  <div style="width:750px; background:#0E213F; border-radius:10px; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,.1); max-height:70vh; overflow-y:auto;">
    <div style="margin:auto; background:#f9f9f9; padding:25px; border-radius:12px; box-shadow:0 0 10px rgba(0,0,0,.05);">

      <!-- Header -->
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 id="modal_title" style="margin:0; color:#2c3e50;">Bank Account Details</h3>
        <div>
          <button type="button" onclick="submitBankForm()" style="background:#e5f9e7; color:green; border:none; padding:6px 14px; border-radius:20px; font-weight:bold; cursor:pointer; margin-right:8px;">‚úî Save</button>
          <button type="button" onclick="closeBankModal()" style="background:#ffe5e5; color:red; border:none; padding:6px 14px; border-radius:20px; font-weight:bold; cursor:pointer;">‚ùå Close</button>
        </div>
      </div>

      <!-- Form -->
      <form id="bank_form" method="POST" action="{% url 'save_bank_account' %}" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        <input type="hidden" id="account_id" name="account_id" value="">

        <div style="display:flex; flex-wrap:wrap; gap:20px; margin-top:20px;">

          <!-- Holder -->
          <div style="flex:1; min-width:250px;">
            <label style="font-weight:bold;">Account Holder Name</label>
            <input id="holder_name" name="account_holder_name" type="text" maxlength="100" required
              placeholder="Enter name" style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
            <div class="field-error" id="err_account_holder_name"></div>
          </div>

          <!-- Bank -->
          <div style="flex:1; min-width:250px;">
            <label style="font-weight:bold;">Bank Name</label>
            <input id="bank_name" name="bank_name" type="text" maxlength="100" required
              placeholder="Enter bank name" style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
            <div class="field-error" id="err_bank_name"></div>
          </div>

          <!-- Type -->
          <div style="flex:1; min-width:250px;">
            <label style="font-weight:bold;">Account Type</label>
            <select id="account_type" name="account_type" required
              style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;"
              onchange="toggleJointFields()">
              <option value="">Select Account Type</option>
              <option value="saving">Saving</option>
              <option value="current">Current</option>
              <option value="salary">Salary</option>
              <option value="nre">NRE</option>
              <option value="nro">NRO</option>
              <option value="jointAcc">Joint Account</option>
            </select>
            <div class="field-error" id="err_account_type"></div>
          </div>

          <!-- Number -->
          <div style="flex:1; min-width:250px;">
            <label style="font-weight:bold;">Account Number</label>
            <!-- BigIntegerField -> max 19 digits. If you switch model to CharField(20), change pattern/max/JS ACC_MAX to 20 -->
            <input id="account_number" name="account_number" type="text" maxlength="19" required
              inputmode="numeric" pattern="^\d{10,19}$"
              placeholder="Enter 10‚Äì19 digit account number" title="Enter 10‚Äì19 digits"
              style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
            <small id="acc_digits_hint" class="text-muted">Digits: 0 </small>
            <div class="field-error" id="err_account_number"></div>
          </div>

          <!-- IFSC -->
          <div style="flex:1; min-width:250px;">
            <label style="font-weight:bold;">IFSC Code</label>
            <input id="ifsc_code" name="ifsc_code" type="text" required
              placeholder="Enter IFSC" pattern="[A-Z]{4}0[A-Z0-9]{6}"
              title="Enter valid IFSC (e.g., SBIN0001234)" oninput="this.value=this.value.toUpperCase()"
              style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
            <div class="field-error" id="err_ifsc_code"></div>
          </div>

          <!-- Status -->
          <div style="flex:1; min-width:250px;">
            <label style="font-weight:bold;">Account Status</label>
            <select id="account_status" name="account_status"
              style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
              <option value="active" selected>Active</option>
              <option value="inactive">Inactive</option>
              <option value="closed">Closed</option>
            </select>
            <div class="field-error" id="err_account_status"></div>
          </div>

          <!-- Linked Phone -->
          <div style="flex:1; min-width:250px;">
            <label style="font-weight:bold;">Linked Phone Number (Optional)</label>
            <input id="linked_phone_number" name="linked_phone_number" type="text"
              placeholder="Enter linked phone number" pattern="^\+?\d{10,13}$" inputmode="tel"
              style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
            <div class="field-error" id="err_linked_phone_number"></div>
          </div>

          <!-- Document Type -->
          <div style="flex:1; min-width:250px;">
            <label style="font-weight:bold;">Document Type</label>
            <select id="document_type" name="document_type" required
              style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;"
              onchange="toggleDocPassword()">
              <option value="">Select Document Type</option>
              <option value="cancelled_cheque">Cancelled Cheque</option>
              <option value="bank_statement">One Month Bank Statement</option>
              <option value="passbook">Front Page of Passbook</option>
            </select>
            <div class="field-error" id="err_document_type"></div>
          </div>

          <!-- Statement -->
          <div style="flex:1; min-width:250px;">
            <label style="font-weight:bold;">Statement Paper (PDF/XLSX)</label>
            <input id="statementPaper" name="statementPaper" type="file" accept=".pdf,.xlsx"
              style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
            <div class="field-error" id="err_statementPaper"></div>
          </div>
        </div>

        <!-- Doc password (conditional) -->
        <div style="flex:1; min-width:250px; display:none; margin-top:12px" id="doc_password_wrapper">
          <label id="doc_password_label" style="font-weight:bold;">Document Password</label>
          <input id="doc_password" name="bankDetails_doc_password" type="text"
            placeholder="Enter document password"
            style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
          <div class="field-error" id="err_bankDetails_doc_password"></div>
        </div>

        <!-- JOINT HOLDER (conditional UI) -->
        <div id="joint_holder_block" style="display:none; margin-top:20px;">
          <h4 style="margin:0 0 10px 0;">Joint Account Holder (KYC)</h4>

          <div style="display:flex; flex-wrap:wrap; gap:20px;">
            <div style="flex:1; min-width:250px;">
              <label style="font-weight:bold;">Full Name</label>
              <input id="joint_holder_name" name="joint_holder_name" type="text" maxlength="120"
                    placeholder="Enter joint holder's name"
                    style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
              <div class="field-error" id="err_joint_holder_name"></div>
            </div>

            <div style="flex:1; min-width:250px;">
              <label style="font-weight:bold;">Aadhaar (PDF/JPG/PNG)</label>
              <input id="joint_holder_aadhaar" name="joint_holder_aadhaar" type="file" accept=".pdf,.jpg,.jpeg,.png"
                    style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;"
                    onchange="toggleAadhaarPassword()">
              <div class="field-error" id="err_joint_holder_aadhaar"></div>
            </div>

            <div style="flex:1; min-width:250px; display:none;" id="aadhaar_password_wrap">
              <label style="font-weight:bold;">Aadhaar PDF Password (if PDF)</label>
              <input id="joint_holder_aadhaar_password" name="joint_holder_aadhaar_password" type="text"
                    placeholder="Enter Aadhaar PDF password"
                    style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
              <div class="field-error" id="err_joint_holder_aadhaar_password"></div>
            </div>

            <div style="flex:1; min-width:250px;">
              <label style="font-weight:bold;">PAN (PDF/JPG/PNG)</label>
              <input id="joint_holder_pan" name="joint_holder_pan" type="file" accept=".pdf,.jpg,.jpeg,.png"
                    style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;"
                    onchange="togglePanPassword()">
              <div class="field-error" id="err_joint_holder_pan"></div>
            </div>

            <div style="flex:1; min-width:250px; display:none;" id="pan_password_wrap">
              <label style="font-weight:bold;">PAN PDF Password (if PDF)</label>
              <input id="joint_holder_pan_password" name="joint_holder_pan_password" type="text"
                    placeholder="Enter PAN PDF password"
                    style="width:100%; padding:8px; border:1px solid #7d8fa0; border-radius:5px;">
              <div class="field-error" id="err_joint_holder_pan_password"></div>
            </div>
          </div>
        </div>

      </form>

      <!-- Error summary (optional) -->
      <div id="bank_error_summary" class="field-error" style="margin-top:12px;"></div>

      <!-- JSON from server for errors + posted values -->
      {% if bank_form_errors %}{{ bank_form_errors|json_script:"bank-errors" }}{% endif %}
      {% if bank_form_post %}{{ bank_form_post|json_script:"bank-post" }}{% endif %}
      {% if open_bank_modal %}<span id="open-bank-flag" hidden></span>{% endif %}

    </div>
  </div>
</div>

<!-- ===================== JS ===================== -->
<script>
  // COUNTER LIMITS
  // BigIntegerField => max 19 digits. If you migrate model to CharField(20), set ACC_MAX = 20 and update input pattern/maxlength to 20.
  const ACC_MIN = 10, ACC_MAX = 19;

  function accDigits(val){ return (val || '').replace(/\D/g,'').length; }

  function updateAccHint(){
    const el = document.getElementById('account_number');
    const hint = document.getElementById('acc_digits_hint');
    if(!el || !hint) return;
    hint.textContent = `Digits: ${accDigits(el.value)} / ${ACC_MAX} (min ${ACC_MIN})`;
  }

  document.addEventListener('input', function(e){
    if(e.target && e.target.id === 'account_number'){ updateAccHint(); }
  });

  function closeOtherModals(keepId) {
    const all = document.querySelectorAll('[id$="_modal"], .modal, [role="dialog"]');
    all.forEach(el => { if (el.id !== keepId) el.style.display = 'none'; });
  }

  function openBankModal(mode) {
    closeOtherModals('bank_modal');
    const modal = document.getElementById('bank_modal');
    modal.style.display = 'flex';
    document.getElementById('modal_title').textContent = 'Bank Account Details';
    if (mode === 'add') {
      document.getElementById('bank_form').reset();
      document.getElementById('account_id').value = '';
      document.getElementById('account_status').value = 'active';
    }
    toggleDocPassword();
    toggleJointFields();
    updateAccHint();
  }

  function closeBankModal() {
    document.getElementById('bank_modal').style.display = 'none';
  }

  function isPdf(fileInput) {
    if (!fileInput || !fileInput.files || !fileInput.files[0]) return false;
    return fileInput.files[0].name.toLowerCase().endsWith('.pdf');
  }

  function toggleDocPassword() {
    const docType = document.getElementById('document_type').value;
    const wrapper = document.getElementById('doc_password_wrapper');
    const label = document.getElementById('doc_password_label');

    if (docType === 'bank_statement') {
      wrapper.style.display = 'block';
      if (label) label.textContent = 'Document Password (Required for Bank Statement PDFs)';
    } else {
      wrapper.style.display = 'none';
      const dp = document.getElementById('doc_password');
      if (dp) dp.value = '';
    }
  }

  function toggleJointFields() {
    const type = document.getElementById('account_type').value;
    const block = document.getElementById('joint_holder_block');
    block.style.display = (type === 'jointAcc') ? 'block' : 'none';
    if (type !== 'jointAcc') {
      ['joint_holder_name','joint_holder_aadhaar_password','joint_holder_pan_password'].forEach(id => {
        const el = document.getElementById(id); if (el) el.value = '';
      });
      const ah = document.getElementById('joint_holder_aadhaar');
      const pan = document.getElementById('joint_holder_pan');
      if (ah) ah.value = '';
      if (pan) pan.value = '';
      document.getElementById('aadhaar_password_wrap').style.display = 'none';
      document.getElementById('pan_password_wrap').style.display = 'none';
    }
  }

  function toggleAadhaarPassword() {
    const wrap = document.getElementById('aadhaar_password_wrap');
    wrap.style.display = isPdf(document.getElementById('joint_holder_aadhaar')) ? 'block' : 'none';
  }

  function togglePanPassword() {
    const wrap = document.getElementById('pan_password_wrap');
    wrap.style.display = isPdf(document.getElementById('joint_holder_pan')) ? 'block' : 'none';
  }

  function submitBankForm() {
    const form = document.getElementById('bank_form');

    if (!form.checkValidity()) { form.reportValidity(); return; }

    // Account number: 10‚Äì19 digits (or 10‚Äì20 if you switch to CharField)
    const acc = document.getElementById('account_number');
    const n = accDigits(acc.value);
    if (n < ACC_MIN || n > ACC_MAX) {
      setFieldError('account_number', [`You entered ${n} digits; required ${ACC_MIN}‚Äì${ACC_MAX}.`]);
      acc.focus(); acc.scrollIntoView({behavior:'smooth', block:'center'});
      return;
    } else {
      setFieldError('account_number', []);
    }

    // IFSC uppercase normalization
    const ifsc = document.getElementById('ifsc_code');
    if (ifsc && ifsc.value) ifsc.value = ifsc.value.toUpperCase();

    // If joint account, require joint KYC
    if (document.getElementById('account_type').value === 'jointAcc') {
      let hasErr = false;

      const jn = document.getElementById('joint_holder_name');
      if (!jn.value.trim()) { setFieldError('joint_holder_name', ['Joint holder name is required.']); hasErr = true; } 
      else setFieldError('joint_holder_name', []);

      const ja = document.getElementById('joint_holder_aadhaar');
      if (!ja.files || ja.files.length === 0) { setFieldError('joint_holder_aadhaar', ['Aadhaar document is required.']); hasErr = true; }
      else {
        setFieldError('joint_holder_aadhaar', []);
        if (isPdf(ja) && !(document.getElementById('joint_holder_aadhaar_password').value || '').trim()) {
          setFieldError('joint_holder_aadhaar_password', ['Aadhaar PDF password is required.']); hasErr = true;
        } else setFieldError('joint_holder_aadhaar_password', []);
      }

      const jp = document.getElementById('joint_holder_pan');
      if (!jp.files || jp.files.length === 0) { setFieldError('joint_holder_pan', ['PAN document is required.']); hasErr = true; }
      else {
        setFieldError('joint_holder_pan', []);
        if (isPdf(jp) && !(document.getElementById('joint_holder_pan_password').value || '').trim()) {
          setFieldError('joint_holder_pan_password', ['PAN PDF password is required.']); hasErr = true;
        } else setFieldError('joint_holder_pan_password', []);
      }

      if (hasErr) {
        const firstInvalid = document.querySelector('.input-invalid');
        (firstInvalid || jn).scrollIntoView({behavior:'smooth', block:'center'});
        return;
      }
    }

    form.submit();
  }

  // ---- helpers to apply server-side errors to fields ----
  function setFieldError(name, messages) {
    const input = document.getElementById(name) || document.querySelector(`[name="${name}"]`);
    const errBox = document.getElementById(`err_${name}`);
    if (!input || !errBox) return;

    const msg = (messages && messages.length) ? (messages[0].message || messages[0]) : '';
    if (msg) {
      input.classList.add('input-invalid');
      input.setAttribute('aria-invalid', 'true');
      errBox.textContent = msg;
    } else {
      input.classList.remove('input-invalid');
      input.removeAttribute('aria-invalid');
      errBox.textContent = '';
    }
  }

  function populatePostedValues(post) {
    if (!post) return;
    const map = {
      account_id: 'account_id',
      account_holder_name: 'holder_name',
      bank_name: 'bank_name',
      account_type: 'account_type',
      account_number: 'account_number',
      ifsc_code: 'ifsc_code',
      account_status: 'account_status',
      linked_phone_number: 'linked_phone_number',
      bankDetails_doc_password: 'doc_password'
      // Add joint fields mapping if you echo them back:
      // joint_holder_name: 'joint_holder_name'
    };
    Object.entries(map).forEach(([postKey, id]) => {
      if (post[postKey] !== undefined) {
        const el = document.getElementById(id);
        if (el) el.value = post[postKey];
      }
    });
    toggleDocPassword();
    toggleJointFields();
    updateAccHint();
  }

  function editBank(id, holder, bank, type, number, ifsc, status, linkedPhone, docPassword, docType) {
    openBankModal('edit');
    document.getElementById('account_id').value = id;
    document.getElementById('holder_name').value = holder;
    document.getElementById('bank_name').value = bank;
    document.getElementById('account_type').value = type;
    document.getElementById('account_number').value = number;
    document.getElementById('ifsc_code').value = ifsc;
    document.getElementById('account_status').value = status || 'active';
    document.getElementById('linked_phone_number').value = linkedPhone || '';
    document.getElementById('doc_password').value = docPassword || '';
    document.getElementById('document_type').value = docType || '';
    toggleDocPassword();
    toggleJointFields();
    updateAccHint();
  }

  (function initBankModalFromServer() {
    const openFlag = document.getElementById('open-bank-flag');
    const errScript = document.getElementById('bank-errors');
    const postScript = document.getElementById('bank-post');

    if (!openFlag && !errScript) return;

    openBankModal('edit');

    let post = {};
    if (postScript) {
      try { post = JSON.parse(postScript.textContent); } catch(e) {}
      populatePostedValues(post);
    }

    let errs = {};
    if (errScript) {
      try { errs = JSON.parse(errScript.textContent); } catch(e) {}
      const fields = [
        'account_holder_name','bank_name','account_type','account_number',
        'ifsc_code','account_status','linked_phone_number','bankDetails_doc_password',
        'document_type','statementPaper',
        'joint_holder_name','joint_holder_aadhaar','joint_holder_aadhaar_password',
        'joint_holder_pan','joint_holder_pan_password'
      ];
      let firstInvalid = null;

      const idMap = {
        account_holder_name:'holder_name',
        bank_name:'bank_name',
        account_type:'account_type',
        account_number:'account_number',
        ifsc_code:'ifsc_code',
        account_status:'account_status',
        linked_phone_number:'linked_phone_number',
        bankDetails_doc_password:'doc_password',
        document_type:'document_type',
        statementPaper:'statementPaper',

        // joint fields
        joint_holder_name:'joint_holder_name',
        joint_holder_aadhaar:'joint_holder_aadhaar',
        joint_holder_aadhaar_password:'joint_holder_aadhaar_password',
        joint_holder_pan:'joint_holder_pan',
        joint_holder_pan_password:'joint_holder_pan_password'
      };

      fields.forEach(f => {
        const msgList = errs[f];
        setFieldError(idMap[f], msgList);
        if (!firstInvalid && msgList && msgList.length) {
          firstInvalid = document.getElementById(idMap[f]);
        }
      });

      const summary = document.getElementById('bank_error_summary');
      if (summary) {
        const lines = [];
        Object.keys(errs).forEach(k => {
          const arr = errs[k] || [];
          arr.forEach(o => lines.push(typeof o === 'string' ? o : (o.message || 'Invalid value')));
        });
        summary.textContent = lines.join(' ‚Ä¢ ');
      }

      toggleJointFields();
      updateAccHint();

      if (firstInvalid) {
        firstInvalid.focus({preventScroll:true});
        firstInvalid.scrollIntoView({behavior:'smooth', block:'center'});
      }
    }
  })();
</script>
