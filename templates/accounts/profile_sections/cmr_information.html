<!-- CMR details -->
<div class="user-personal_Information">
    <div class="user-personal_Information-label">
        <div>CMR Copy</div>
        <button onclick="openModalCMR()">‚ûï Add CMR</button>
    </div>

    {% if cmr_form.errors %}
        <div style="color:red; margin:10px 0;">
            {{ cmr_form.errors }}
        </div>
    {% endif %}

    <div class="user-personal_Information-feilds">
        <div style="overflow-x:auto;">
            <div style="min-width:800px;">
                <!-- Table Header -->
                <div style="display:grid; grid-template-columns:repeat(4,1fr) 1fr; font-weight:600; color:#2c3e50; padding:10px 0; border-bottom:2px solid #eee;">
                    <div>Broker Name</div>
                    <div>Broker ID</div>
                    <div>Client ID</div>
                    <div>CMR File</div>
                    <div style="text-align:right;">Actions</div>
                </div>

                <!-- Table Rows -->
                {% for cmr in cmr_copies %}
                <div style="display:grid; grid-template-columns:repeat(4,1fr) 1fr; align-items:center; padding:15px 0; border-bottom:1px solid #f0f0f0; color:#344767;">
                    <div>{{ cmr.broker.name }}</div>
                    <div>{{ cmr.broker.broker_id }}</div>
                    <div>{{ cmr.client_id_input }}</div>
                    <div>
                        {% if cmr.cmr_file %}
                            <!-- Download -->
                            <a href="{% url 'download_cmr_file' cmr.id %}" title="Download" style="text-decoration:none;">üíæ</a>

                            <!-- Preview -->
                            <button type="button" onclick="openCMRPreview('{{ cmr.cmr_file.url }}')" style="margin-left:8px; background:none; border:none; cursor:pointer;" title="View">üëÅÔ∏è</button>
                        {% else %}
                            <span style="color:#aaa;">No File</span>
                        {% endif %}
                    </div>

                    <div style="display:flex; gap:8px; justify-content:flex-end;">
                        <button onclick="openModalCMR('{{ cmr.id }}', '{{ cmr.broker.id }}', '{{ cmr.broker_id_input }}', '{{ cmr.client_id_input }}')" style="padding:6px 12px; border:1px solid #b0b8c1; border-radius:24px; background:white; color:#344767; cursor:pointer;">‚úèÔ∏è</button>
                        <form method="post" action="{% url 'delete_cmr' cmr.id %}" onsubmit="return confirm('Are you sure you want to delete this CMR copy?');">
                            {% csrf_token %}
                            <button type="submit" style="padding:6px 12px; border:1px solid #e57373; border-radius:24px; background:white; color:#d32f2f; cursor:pointer;">üóëÔ∏è</button>
                        </form>
                    </div>
                </div>
                {% empty %}
                    <p style="color:#888;">No brokers added yet.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- CMR Modal -->
<div id="edit_cmr_modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);">
    <div style="background:#fff; border-radius:12px; max-width:900px; margin:auto; margin-top:50px; box-shadow:0 8px 20px rgba(0,0,0,0.3); overflow:hidden;">
        <!-- Modal Header -->
        <div style="background:#0E213F; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; color:#fff;">
            <h3 style="margin:0;">Add / Edit CMR Copy</h3>
            <div>
                <button type="submit" form="cmr_form" style="background-color:#4CAF50; color:white; border:none; padding:8px 18px; border-radius:20px; font-weight:bold; cursor:pointer; margin-right:10px;">‚úî Save</button>
                <button type="button" onclick="closeModalCMR()" style="background-color:#f44336; color:white; border:none; padding:8px 18px; border-radius:20px; font-weight:bold; cursor:pointer;">‚ùå Close</button>
            </div>
        </div>

        <!-- Modal Body -->
        <div style="padding:25px; background:#f9f9f9;">
            {% if cmr_form.errors %}
                <div style="color:red; margin-bottom:15px;">
                    {{ cmr_form.errors }}
                </div>
            {% endif %}

            <form method="post" enctype="multipart/form-data" id="cmr_form" action="{% url 'profile' %}">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="cmr_form">
                <input type="hidden" name="cmr_id" id="cmr_id" value="">

                <div style="display:flex; flex-wrap:wrap; gap:20px;">
                    <div style="flex:1;">
                        <label>Broker Name</label><br>
                        <select name="broker" id="broker" required style="width:100%; padding:8px 12px; border-radius:6px; border:1px solid #ccc;">
                            <option value="">-- Select Broker --</option>
                            {% for broker in brokers %}
                                <option value="{{ broker.id }}">{{ broker.name }}</option>
                            {% endfor %}
                        </select>

                        <div style="margin-top:15px;">
                            <label>Broker ID</label><br>
                            <input type="text" name="broker_id_input" id="broker_id_input" value="" readonly style="padding:8px 12px; border-radius:6px; border:1px solid #ccc; width:100%;">
                        </div>

                        <div style="margin-top:15px;">
                            <label>Client ID</label><br>
                            <input type="text" name="client_id_input" id="client_id_input" value="" style="padding:8px 12px; border-radius:6px; border:1px solid #ccc; width:100%;">
                        </div>
                    </div>

                    <div style="flex:1;">
                        <label>Upload CMR</label><br>
                        <input type="file" name="cmr_file" accept=".pdf,.jpg,.jpeg,.png" style="padding:4px;">
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- CMR Preview Modal -->
<div id="cmrPreviewModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000;">
    <div style="background:white; max-width:80%; max-height:90%; margin:auto; margin-top:5%; padding:20px; border-radius:10px; position:relative;">
        <button onclick="closeCMRPreview()" style="position:absolute; top:10px; right:10px; background:#ffdddd; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer;">‚ùå</button>
        <div id="cmrPreviewContent" style="text-align:center; max-height:80vh; overflow:auto;"></div>
    </div>
</div>

<!-- JS -->
<script>
const brokerIdMap = {
    {% for broker in brokers %}
        "{{ broker.id }}": "{{ broker.broker_id }}",
    {% endfor %}
};

function openModalCMR(cmrId = null, brokerId = null, brokerInput = '', clientInput = '') {
    document.getElementById('edit_cmr_modal').style.display = 'block';
    document.getElementById('cmr_id').value = cmrId || '';

    const brokerSelect = document.getElementById('broker');
    brokerSelect.value = brokerId || '';
    document.getElementById('client_id_input').value = clientInput || '';

    const brokerInputField = document.getElementById('broker_id_input');
    brokerInputField.value = brokerId && brokerIdMap[brokerId] ? brokerIdMap[brokerId] : '';
}

document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('broker').addEventListener('change', function () {
        document.getElementById('broker_id_input').value = brokerIdMap[this.value] || '';
    });
});

function closeModalCMR() {
    const modal = document.getElementById('edit_cmr_modal');
    modal.style.display = 'none';
    document.getElementById('cmr_form').reset();
    document.getElementById('broker_id_input').value = '';
}

function openCMRPreview(fileUrl) {
    const previewContainer = document.getElementById('cmrPreviewContent');
    const modal = document.getElementById('cmrPreviewModal');
    const extension = fileUrl.split('.').pop().toLowerCase();

    if (['jpg','jpeg','png'].includes(extension)) {
        previewContainer.innerHTML = `<img src="${fileUrl}" alt="CMR Copy" style="max-width:100%; max-height:80vh;">`;
    } else if (extension === 'pdf') {
        previewContainer.innerHTML = `<object data="${fileUrl}" type="application/pdf" width="100%" height="600px"><p>PDF cannot be previewed. <a href="${fileUrl}" target="_blank">Open in new tab</a>.</p></object>`;
    } else {
        previewContainer.innerHTML = `<p>Preview not available for this file type.</p>`;
    }
    modal.style.display = 'block';
}

function closeCMRPreview() {
    document.getElementById('cmrPreviewModal').style.display = 'none';
    document.getElementById('cmrPreviewContent').innerHTML = '';
}
</script>
