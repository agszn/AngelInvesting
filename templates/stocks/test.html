<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Text Formatter</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body { padding: 20px; }
    #textInput { width: 100%; height: 200px; margin-bottom: 20px; }
    #outputArea { border: 1px solid #ddd; padding: 15px; min-height: 200px; background:#fff; }
    .navbar {
      position: fixed; right: 20px; top: 20px; width: 220px; z-index: 1000;
      border: 1px solid rgba(0,0,0,.08); border-radius: 12px; box-shadow: 0 10px 30px rgba(2,6,23,.08);
    }
    .content-area { margin-right: 240px; }
    #tagDisplay {
      border: 1px solid #ccc; padding: 10px; margin-top: 10px; background-color: #f9f9f9; white-space: pre-wrap;
      min-height: 120px;
    }
    .toolbar-title { font-weight: 700; font-size: 1rem; }
  </style>
</head>
<body>
  <!-- Floating Toolbar -->
  <nav class="navbar navbar-light bg-light flex-column p-3">
    <div class="toolbar-title mb-2">Format Options</div>
    <div class="d-grid gap-2 w-100">
      <button class="btn btn-primary" type="button" onclick="formatText('bold')">Bold</button>
      <button class="btn btn-primary" type="button" onclick="formatText('title')">Title (H2)</button>
      <button class="btn btn-primary" type="button" onclick="formatText('normal')">Normal Text</button>
      <button class="btn btn-primary" type="button" onclick="formatText('list')">List</button>
      <hr class="my-2"/>
      <button class="btn btn-secondary" type="button" onclick="copyOutputHTML()">Copy HTML</button>
      <button class="btn btn-secondary" type="button" onclick="downloadOutputHTML()">Download HTML</button>
      <button class="btn btn-danger" type="button" onclick="clearOutput()">Clear Output</button>
    </div>
  </nav>

  <!-- Text Input and Output -->
  <div class="container content-area">
    <h3>Enter and Select Text</h3>
    <textarea id="textInput" class="form-control" placeholder="Type your text here..."></textarea>

    <h3 class="mt-4">Formatted Output</h3>
    <div id="outputArea" contenteditable="true"></div>

    <h3 class="mt-4">Tags Applied (raw)</h3>
    <div id="tagDisplay"></div>
  </div>

  <!-- Bootstrap JS (bundle) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- DOMPurify for sanitization -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <script>
    // State
    let currentParagraph = null;
    let tagDisplayAgg = '';

    // Elements
    const output = document.getElementById('outputArea');
    const tagDisplayDiv = document.getElementById('tagDisplay');
    const textarea = document.getElementById('textInput');

    // Helpers
    function sanitize(html) {
      return DOMPurify.sanitize(html, {
        ALLOWED_TAGS: ['h2','p','ul','li','span','b','strong','em'],
        ALLOWED_ATTR: ['style']
      });
    }

    function escapeText(text) {
      return text.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    }

    function appendHTML(container, html) {
      container.insertAdjacentHTML('beforeend', html);
    }

    function updateTagsPanel() {
      // Show raw literal tags (not rendered)
      tagDisplayDiv.textContent = tagDisplayAgg;
    }

    // Main action
    function formatText(type) {
      const start = textarea.selectionStart ?? 0;
      const end = textarea.selectionEnd ?? 0;
      const selectedText = textarea.value.substring(start, end);

      if (!selectedText.trim()) {
        alert('Please select some text first!');
        return;
      }

      // Escape user text so pasted HTML is not executed/rendered
      const safeText = escapeText(selectedText);
      const lines = safeText.split('\n').map(s => s.trim()).filter(Boolean);

      if (type === 'bold') {
        // Continues the current paragraph; create if missing
        if (!currentParagraph) {
          appendHTML(output, '<p></p>');
          currentParagraph = output.lastElementChild;
        }
        const span = `<span style="font-weight:bold;">${safeText}</span>`;
        const sanitizedSpan = sanitize(span);
        currentParagraph.innerHTML += sanitizedSpan;
        tagDisplayAgg += `<span style="font-weight:bold;">${selectedText}</span>\n`;
      } else if (type === 'title') {
        const block = `<h2>${safeText}</h2>`;
        appendHTML(output, sanitize(block));
        tagDisplayAgg += `<h2>${selectedText}</h2>\n`;
        currentParagraph = null;
      } else if (type === 'normal') {
        const block = `<p>${safeText}</p>`;
        appendHTML(output, sanitize(block));
        tagDisplayAgg += `<p>${selectedText}</p>\n`;
        currentParagraph = null;
      } else if (type === 'list') {
        const items = lines.map(line => `  <li>${line}</li>`).join('\n');
        const block = `<ul>\n${items}\n</ul>`;
        appendHTML(output, sanitize(block));
        tagDisplayAgg += `<ul>\n${lines.map(l => `  <li>${l}</li>`).join('\n')}\n</ul>\n`;
        currentParagraph = null;
      }

      updateTagsPanel();
      // Keep focus in textarea for rapid formatting passes
      textarea.focus();
    }

    function clearOutput() {
      output.innerHTML = '';
      tagDisplayAgg = '';
      currentParagraph = null;
      updateTagsPanel();
    }

    async function copyOutputHTML() {
      const html = output.innerHTML;
      try {
        await navigator.clipboard.writeText(html);
        showToast('Output HTML copied to clipboard');
      } catch (e) {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = html;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showToast('Output HTML copied (fallback)');
      }
    }

    function downloadOutputHTML() {
      const html = `<!doctype html>
<html>
<head><meta charset="utf-8"><title>Formatted Output</title></head>
<body>
${output.innerHTML}
</body>
</html>`;
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'formatted_output.html';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Small toast using Bootstrap if available
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast align-items-center text-bg-dark border-0 position-fixed bottom-0 end-0 m-3';
      toast.role = 'status';
      toast.ariaLive = 'polite';
      toast.ariaAtomic = 'true';
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>`;
      document.body.appendChild(toast);
      const t = new bootstrap.Toast(toast, { delay: 1500 });
      t.show();
      toast.addEventListener('hidden.bs.toast', () => toast.remove());
    }

    // Keyboard shortcuts (while cursor in textarea)
    textarea.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        const k = e.key.toLowerCase();
        if (k === 'b') { e.preventDefault(); formatText('bold'); }
        if (k === 'l') { e.preventDefault(); formatText('list'); }
        if (k === '2') { e.preventDefault(); formatText('title'); }
        if (k === 'p') { e.preventDefault(); formatText('normal'); }
      }
      // Reset paragraph grouping on Enter to start a new one for bold
      if (e.key === 'Enter') currentParagraph = null;
    });
  </script>
</body>
</html>
