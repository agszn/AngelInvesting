{% extends 'base.html' %}
{% block title %}Stock List{% endblock %}
{% load static %}

{% load custom_filters %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/listingview.css' %}" />

<main class="stock-container">
  <form method="get" id="filter-form">
    <div class="controls">
      <div class="show-entries">
        Show
        <select id="entries-select" name="entries" onchange="document.getElementById('filter-form').submit();">
          <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
          <option value="15" {% if per_page == 15 %}selected{% endif %}>15</option>
          <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
          <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
        </select>
        entries
      </div>
      <!-- templates/stocks/stockListTable.html -->
      <div class="search-filter">
        <input type="text" name="search" placeholder="Search here..." id="search-input" value="{{ search_query }}">
        <button type="submit" id="filter-btn">Filter</button>
      </div>
    </div>
  </form>
  <div id="stock-table-container">
    <div class="table-container">
      <table id="stock-table">
        <thead>
          <tr>
            <th>Sl No</th>
            <th class="logo"></th>
            <th>Share Name</th>
            <th>Sector</th>
            <th>Price <br><span class="inline">In ₹ Per Share</span></th>
            <th>Market Cap <br><span class="inline">In ₹ Crores</span></th>
            <th>Lifetime High</th>
            <th>Lifetime Low</th>
            <th class="chart">Chart</th>
            <th class="options">Options</th>
          </tr>
        </thead>

        <tbody id="stock-table-body">
          {% include 'stocks/partials/stock_table_rows.html' %}
        </tbody>

      </table>
    </div>

    <div class="pagination">
      <div class="pagination-info">
        Showing {{ start_index }} to {{ end_index }} of {{ total_count }} entries
      </div>
      <div class="page-numbers">
        {% if page_obj.has_previous %}
          <a href="?{% if search_query %}search={{ search_query }}&{% endif %}entries={{ per_page }}&page={{ page_obj.previous_page_number }}">Previous</a>
        {% endif %}

        {% for page_num in page_obj.paginator.page_range %}
          {% if page_num == page_obj.number %}
            <a href="#" class="active">{{ page_num }}</a>
          {% elif page_num >= page_obj.number|add:"-2" and page_num <= page_obj.number|add:"2" %}
            <a href="?{% if search_query %}search={{ search_query }}&{% endif %}entries={{ per_page }}&page={{ page_num }}">{{ page_num }}</a>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <a href="?{% if search_query %}search={{ search_query }}&{% endif %}entries={{ per_page }}&page={{ page_obj.next_page_number }}">Next</a>
        {% endif %}
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const stockHistoryData = {{ stock_history_data|safe }};

    Object.entries(stockHistoryData).forEach(([stockId, dataPoints]) => {
      const ctx = document.getElementById(`chart-${stockId}`)?.getContext('2d');
      if (!ctx) return;

      const dates = dataPoints.map(dp => dp.timestamp);
      const prices = dataPoints.map(dp => dp.price);

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: '',
            data: prices,
            borderColor: 'rgba(255, 215, 0, 0.8)',
            backgroundColor: 'rgba(255, 215, 0, 0.1)',
            borderWidth: 2,
            pointRadius: 0
          }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: true,
          scales: {
            x: { display: false },
            y: { display: false }
          },
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
          }
        }
      });
    });
  </script>

</main>

{% endblock %}
