{% extends 'base.html' %}
{% block title %}Stock List{% endblock %}
{% load static %}

{% load custom_filters %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/listingview.css' %}" />
<style>
  .hero-headers-listtable {
      text-align: center;
      padding-bottom: 40px;
      margin-top:20px;
  }
  .heading {
      font-size: 45px;
      font-weight: 700;
      font-family: 'Newsreader', serif;
      padding: 0;
      margin: 0;
  }
  @media (min-width: 320px) and (max-width: 767px) 
  {
    .hero-headers-listtable 
    {
      padding-bottom: 0;
    }
    .hero-headers-listtable .heading {
      font-size: 24px;
      text-align: center;
      padding: 0;
    }
  }
</style>

<div class="hero-headers-listtable" style="text-align:center; ">
  <h1 class="heading">
    Explore <span class="highlight" style="color:#25D366;">Unlisted Shares</span>
  </h1>
</div>

<main class="stock-container">
  <!-- Centered Grid/List Toggle -->
  <div style="text-align:center; margin:20px 0 0 0;">
    <div style="display:inline-flex; align-items:center; background:#fff; border-radius:6px; overflow:hidden; box-shadow:#25D366;">
      
      <!-- Grid View Button -->
      <a href="{% url 'unlisted_stock_marketplace:stock_list' %}" 
        style="text-decoration:none; padding:10px 20px; font-size:16px; font-weight:bold; cursor:pointer; display:inline-block;
        {% if request.resolver_match.url_name == 'stock_list' %}
            background:#25D366; color:#fff;
        {% else %}
            color:#222;
        {% endif %}">
        Grid View
      </a>
      
      <!-- <div style="width:1px; background:#444; height:24px;"></div> -->
      
      <!-- List View Button -->
      <a href="{% url 'unlisted_stock_marketplace:StockListingTableFormat' %}" 
        style="text-decoration:none; padding:10px 20px; font-size:16px; font-weight:bold; cursor:pointer; display:inline-block;
        {% if request.resolver_match.url_name == 'StockListingTableFormat' %}
            background:#25D366; color:#fff;
        {% else %}
            color:#222;
        {% endif %}">
        List View
      </a>
    
    </div>
  </div>
  <form method="get" id="filter-form">
    <div class="controls">
      <div class="show-entries">
        Show
        <select id="entries-select" name="entries" onchange="document.getElementById('filter-form').submit();">
          <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
          <option value="15" {% if per_page == 15 %}selected{% endif %}>15</option>
          <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
          <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
        </select>
        entries
      </div>
      <!-- templates/stocks/stockListTable.html -->
      <div class="search-filter">
        <input type="text" name="search" placeholder="Search here..." id="search-input" value="{{ search_query }}">
        <button type="submit" id="filter-btn">Filter</button>
      </div>
    </div>
  </form>
  <div id="stock-table-container">
    <div class="table-container">
      <table id="stock-table">
        <thead>
          <tr>
            <th>Sl No</th>
            <!-- <th class="logo"></th> -->
            <th>Share Name</th>
            <th>Sector</th>
            <th>Price</th>
            <th>Market Cap <br><span class="inline">In â‚¹ Crores</span></th>
            <th>Number of Outstanding Shares</th>
            <th>PE Ratio</th>
            <!-- <th class="chart">Chart</th> -->
            <th class="options">Options</th>
          </tr>
        </thead>

        <tbody id="stock-table-body">
          {% include 'stocks/partials/stock_table_rows.html' %}
        </tbody>

      </table>
    </div>

    <div class="pagination">
      <div class="pagination-info">
        Showing {{ start_index }} to {{ end_index }} of {{ total_count }} entries
      </div>
      <div class="page-numbers">
        {% if page_obj.has_previous %}
          <a href="?{% if search_query %}search={{ search_query }}&{% endif %}entries={{ per_page }}&page={{ page_obj.previous_page_number }}">Previous</a>
        {% endif %}

        {% for page_num in page_obj.paginator.page_range %}
          {% if page_num == page_obj.number %}
            <a href="#" class="active">{{ page_num }}</a>
          {% elif page_num >= page_obj.number|add:"-2" and page_num <= page_obj.number|add:"2" %}
            <a href="?{% if search_query %}search={{ search_query }}&{% endif %}entries={{ per_page }}&page={{ page_num }}">{{ page_num }}</a>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <a href="?{% if search_query %}search={{ search_query }}&{% endif %}entries={{ per_page }}&page={{ page_obj.next_page_number }}">Next</a>
        {% endif %}
      </div>
    </div>
  </div>















  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const stockHistoryData = {{ stock_history_data|safe }};

    Object.entries(stockHistoryData).forEach(([stockId, dataPoints]) => {
      const ctx = document.getElementById(`chart-${stockId}`)?.getContext('2d');
      if (!ctx) return;

      const dates = dataPoints.map(dp => dp.timestamp);
      const prices = dataPoints.map(dp => dp.price);

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: '',
            data: prices,
            borderColor: 'rgba(255, 215, 0, 0.8)',
            backgroundColor: 'rgba(255, 215, 0, 0.1)',
            borderWidth: 2,
            pointRadius: 0
          }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: true,
          scales: {
            x: { display: false },
            y: { display: false }
          },
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
          }
        }
      });
    });
  </script>

</main>

{% endblock %}
