{% extends "baseStructureSM.html" %}
{% load static %}
{% block title %}Banner{% endblock %}
{% block subtitle %}Homepage Banner{% endblock %}

{% block SMprofile_content %}
<style>
  /* ===== Layout & Cards ===== */
  .ui-card {
    background: #fff;
    border: 1px solid rgba(13,71,161,.08);
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(13,71,161,.06);
  }
  .ui-card-header {
    padding: 16px 18px;
    border-bottom: 1px solid rgba(0,0,0,.06);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .ui-card-body { padding: 18px; }

  /* ===== Filter row ===== */
  .filter-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: flex-end;
  }
  .filter-chip {
    display: inline-flex; align-items: center; gap: 6px;
    background: #eef5ff; color: #0d47a1;
    border: 1px solid #d7e7ff; border-radius: 999px;
    padding: 6px 10px; font-size: .85rem; font-weight: 600;
  }

  /* ===== Table ===== */
  .SMtable-scroll-container {
    overflow: auto;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,.06);
    background: #fff;
  }
  .user-portfolio-toptable1 {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.95rem;
  }
  .user-portfolio-toptable1 thead th {
    position: sticky; top: 0; z-index: 2;
    background: #f8fbff;
    color: #29415f;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .02em;
    padding: 12px 14px;
    border-bottom: 1px solid rgba(0,0,0,.06);
  }
  .user-portfolio-toptable1 tbody td {
    padding: 12px 14px;
    border-bottom: 1px solid rgba(0,0,0,.05);
    vertical-align: middle;
    word-wrap: break-word;
    overflow-wrap: anywhere;
    white-space: normal;
  }
  .user-portfolio-toptable1 tbody tr:hover {
    background: #f7fbff;
  }
  .col-company { min-width: 260px; }
  .col-scrip   { min-width: 140px; }
  .col-sector  { min-width: 160px; }
  .col-conv    { min-width: 140px; }
  .col-price   { min-width: 130px; text-align: right; }
  .col-actions { min-width: 120px; text-align: right; }

  /* ===== Badges ===== */
  .badge-scrip {
    background: #f0f4ff; color: #274ea6; border: 1px solid #dfe8ff;
    padding: 4px 8px; border-radius: 10px; font-weight: 600;
  }
  .badge-sector {
    background: #f7f9fc; color: #425466; border: 1px solid #e9edf3;
    padding: 4px 8px; border-radius: 10px;
  }
  .conv-badge {
    font-weight: 700; padding: 4px 10px; border-radius: 999px; border: 1px solid;
  }
  .conv-high  { background:#fff4f2; color:#b23c17; border-color:#ffd7ce; }
  .conv-medium{ background:#fff9e8; color:#8a6b00; border-color:#ffeaa3; }
  .conv-low   { background:#eefaf2; color:#1b6e3a; border-color:#c9f0d8; }

  /* ===== Utilities ===== */
  .muted { color: #6b7a90; }
  .btn-icon {
    display: inline-flex; align-items: center; gap: 6px;
  }

  /* Responsive tweaks */
  @media (max-width: 768px) {
    .filter-actions { justify-content: stretch; }
  }
</style>

<div class="user-portfolio-top mb-3">
  <div class="user-dashboard-heading d-flex align-items-center justify-content-between">
    <h3 class="mb-0">StockData - 
    <span class="mb-0">Total: {{ stocks|length }}</span> </h3>
  </div>
</div>

<!-- ===== Filters Card ===== -->
<div class="ui-card mb-3">
  <div class="ui-card-header">
    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-funnel"></i>
      <strong style="color: black;">Filters</strong>
    </div>
    <div class="filter-actions">
      {% if filters.search_query or filters.sector or filters.category or filters.conviction_level or filters.stock_type %}
        <!-- Applied filter chips -->
        {% if filters.search_query %}<span class="filter-chip"><i class="bi bi-search"></i> {{ filters.search_query }}</span>{% endif %}
        {% if filters.sector %}<span class="filter-chip"><i class="bi bi-diagram-3"></i> {{ filters.sector }}</span>{% endif %}
        {% if filters.category %}<span class="filter-chip"><i class="bi bi-collection"></i> {{ filters.category }}</span>{% endif %}
        {% if filters.conviction_level %}<span class="filter-chip"><i class="bi bi-lightning-charge"></i> {{ filters.conviction_level }}</span>{% endif %}
        {% if filters.stock_type %}<span class="filter-chip"><i class="bi bi-tags"></i> {{ filters.stock_type }}</span>{% endif %}
        <a href="?" class="btn btn-sm btn-outline-secondary">Reset</a>
      {% endif %}
    </div>
  </div>
  <div class="ui-card-body">
    <form method="get" class="row g-2">
      <div class="col-md-4">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input type="text" name="search" class="form-control" placeholder="Company / Scrip / ISIN" value="{{ filters.search_query }}">
        </div>
      </div>

      <div class="col-md-2">
        <select name="sector" class="form-select">
          <option value=""> Sectors</option>
          {% for sector in sectors %}
            <option value="{{ sector }}" {% if filters.sector == sector %}selected{% endif %}>{{ sector }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- <div class="col-md-2">
        <select name="category" class="form-select">
          <option value=""> Categories</option>
          {% for category in categories %}
            <option value="{{ category }}" {% if filters.category == category %}selected{% endif %}>{{ category }}</option>
          {% endfor %}
        </select>
      </div> -->

      <div class="col-md-2">
        <select name="conviction_level" class="form-select">
          <option value=""> Conviction Levels</option>
          {% for cl in conviction_levels %}
            <option value="{{ cl }}" {% if filters.conviction_level == cl %}selected{% endif %}>{{ cl }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <select name="stock_type" class="form-select">
          <option value=""> Stock Types</option>
          {% for st in stock_types %}
            <option value="{{ st }}" {% if filters.stock_type == st %}selected{% endif %}>{{ st }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <a href="?" class="btn btn-light">Clear</a>
        <button type="submit" class="btn btn-primary btn-icon">
          <i class="bi bi-funnel"></i> Apply
        </button>
      </div>
      <div class="col-md-12 d-flex justify-content-end gap-2 mt-2">
        <!-- <a href="?" class="btn btn-light">Clear</a>
        <button type="submit" class="btn btn-primary btn-icon">
          <i class="bi bi-funnel"></i> Apply
        </button> -->
        <!-- <a href="{% url 'SM_User:create_stockdata' %}" class="btn btn-primary btn-sm btn-icon">
          <i class="bi bi-plus-circle"></i> New
        </a> -->

      </div>
    </form>
  </div>
</div>

<!-- ===== Table ===== -->
<div class="SMtable-head">
  <div class="SMtable-scroll-container">
    <table class="user-portfolio-toptable1">
      <thead class="user-portfolio-head-admin">
        <tr>
          <th class="col-company">Company</th>
          <th class="col-scrip">Scrip</th>
          <th class="col-sector">Sector</th>
          <th class="col-conv">Conviction</th>
          <th class="col-price">Share Price</th>
          <th class="col-actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for stock in stocks %}
          <tr>
            <td class="col-company">
              <div class="fw-semibold">{{ stock.company_name }}</div>
              {% if stock.isin %}<div class="muted small">ISIN: {{ stock.isin }}</div>{% endif %}
            </td>
            <td class="col-scrip">
              {% if stock.scrip_name %}
                <span class="badge-scrip">{{ stock.scrip_name }}</span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td class="col-sector">
              {% if stock.sector %}
                <span class="badge-sector">{{ stock.sector }}</span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td class="col-conv">
              {% with cl=stock.conviction_level|default:"" %}
                {% if cl|lower == "high" %}
                  <span class="conv-badge conv-high">High</span>
                {% elif cl|lower == "medium" %}
                  <span class="conv-badge conv-medium">Medium</span>
                {% elif cl|lower == "low" %}
                  <span class="conv-badge conv-low">Low</span>
                {% elif cl %}
                  <span class="conv-badge" style="background:#f3f6f9;color:#3a5169;border-color:#e2e8f0;">{{ cl }}</span>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              {% endwith %}
            </td>
            <td class="col-price">
              {% if stock.share_price %}
                ₹ {{ stock.share_price|floatformat:2 }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td class="col-actions">
              <div class="btn-group">
                <a href="{% url 'SM_User:edit_stockdata' stock.pk %}" class="btn btn-sm btn-warning">Edit</a>
                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                  <span class="visually-hidden">More</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  {% comment %} Add more actions as needed {% endcomment %}
                  <li><a class="dropdown-item" href="{% url 'SM_User:edit_stockdata' stock.pk %}"><i class="bi bi-pencil-square me-2"></i>Edit details</a></li>

                  <li><a class="dropdown-item" href="{% url 'SM_User:stockdata_delete' pk=stock.pk %}"><i class="bi bi-trash"></i> Delete Stock</a></li>



                  {% if stock.get_absolute_url %}
                  <li><a class="dropdown-item" href="{{ stock.get_absolute_url }}"><i class="bi bi-eye me-2"></i>View page</a></li>
                  {% endif %}
                  <!-- <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-trash3 me-2"></i>Delete</a></li> -->
                </ul>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="6" class="text-center py-5">
              <div class="muted mb-2" style="font-size:2rem;">🧐</div>
              <div class="fw-semibold mb-1">No matching stocks found</div>
              <div class="muted mb-3">Try adjusting your filters or clearing them.</div>
              <a href="?" class="btn btn-outline-secondary btn-sm">Reset Filters</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Optional: pagination controls if you pass page_obj -->
{% if page_obj %}
<nav class="mt-3 d-flex justify-content-between align-items-center">
  <span class="muted small">
    Showing {{ page_obj.start_index }}–{{ page_obj.end_index }} of {{ page_obj.paginator.count }}
  </span>
  <ul class="pagination mb-0">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET %}&{{ request.GET.urlencode|safe|cut:'page='|cut:page_obj.number|stringformat:'s' }}{% endif %}">Previous</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
    {% endif %}
    <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET %}&{{ request.GET.urlencode|safe|cut:'page='|cut:page_obj.number|stringformat:'s' }}{% endif %}">Next</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}
{% endblock %}
