{% extends "baseStructureSM.html" %}
{% block title %}{{ title }}{% endblock %}
{% block SMprofile_content %}

<style>
  :root{
    --ai-bg:#0b1f3a;          /* dark blue page background */
    --ai-card:#ffffff;
    --ai-border:#e5e7eb;
    --ai-primary:#0d47a1;
    --ai-primary-600:#0b3c8a;
    --ai-muted:#6b7280;
    --ai-text:#111827;        /* dark text on light surfaces */
  }

  /* Page chrome */
  body{ background: var(--ai-bg) !important; }

  .ai-wrap{ max-width: 1060px; margin: 0 auto; padding: 22px 18px; }

  /* Card surfaces: force dark readable text */
  .ai-card{
    background: var(--ai-card);
    border: 1px solid var(--ai-border);
    border-radius: 14px;
    box-shadow: 0 12px 28px rgba(2,6,23,.12);
    color: var(--ai-text);
  }
  .ai-card > .ai-card{ box-shadow: 0 6px 14px rgba(2,6,23,.08); }

  /* Typography + controls inside cards should never inherit white text */
  .ai-card,
  .ai-card *:not(.btn):not(.badge):not([class*="text-"]){
    color: var(--ai-text);
  }
  .ai-label{ font-weight: 600; color: var(--ai-text); }

  /* Form controls */
  .ai-card input[type="text"],
  .ai-card input[type="number"],
  .ai-card input[type="url"],
  .ai-card input[type="email"],
  .ai-card input[type="date"],
  .ai-card input[type="time"],
  .ai-card select,
  .ai-card textarea,
  .ai-card .form-control{
    background:#fff !important;
    color: var(--ai-text) !important;
    border: 1px solid var(--ai-border) !important;
    border-radius: 10px !important;
  }
  .ai-card ::placeholder{ color:#9ca3af; }

  /* Helper text / muted text */
  small, .text-muted{ color: var(--ai-muted) !important; }
  .form-check-label{ color: var(--ai-text); }

  /* Buttons */
  .ai-btn{
    background: var(--ai-primary);
    border: none; color: #fff;
    padding: 8px 14px; border-radius: 10px;
  }
  .ai-btn:hover{ background: var(--ai-primary-600); }

  /* Floating toolbar lowered and scrollable */
  .tf-toolbar{
    position: fixed;
    right: 20px;
    top: 100px;               /* lower than before */
    width: 260px;
    z-index: 1000;
    border: 1px solid rgba(0,0,0,.08);
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(2,6,23,.18);
    background: #f8f9fa;
    max-height: calc(100vh - 140px);
    overflow: auto;
  }
  .tf-content-area{ margin-right: 300px; }

  .tf-preview{
    border: 1px solid #e5e7eb;
    background: #fff;
    padding: 10px;
    min-height: 80px;
    border-radius: 8px;
    color: var(--ai-text);
  }

  /* Textareas nicer */
  textarea{
    width: 100%;
    min-height: 140px;
    border-radius: 10px;
    border: 1px solid var(--ai-border);
    padding: 10px 12px;
    line-height: 1.5;
    resize: vertical;
    color: var(--ai-text);
    background: #ffffff;
  }

  /* Mobile / narrow screens: toolbar docks at bottom, toggle shown */
  @media (max-width: 1024px){
    .tf-content-area{ margin-right: 0; }
    .tf-toolbar{
      position: fixed;
      right: 12px; left: 12px;
      bottom: 14px; top: auto;
      width: auto;
      max-height: 62vh;
      border-radius: 14px;
    }
  }
  .tf-toggle{
    display:none;
    position: fixed; right: 18px; bottom: 18px; z-index: 1001;
  }
  @media (max-width: 1024px){ .tf-toggle{ display:inline-block; } }
</style>

<button class="btn btn-dark tf-toggle" type="button" onclick="tfToggleToolbar()">
  Formatter
</button>

<div class="ai-wrap tf-content-area">
  <div class="ai-card p-3">
    <h4 class="mb-3">{{ title }} – {{ stock.company_name }}</h4>

    <form method="post">
      {% csrf_token %}
      {{ formset.management_form }}

      <div id="report-forms">
        {% for form in formset %}
          {{ form.id }}
          <div class="ai-card p-3 mb-3">
            <div class="mb-2">
              <label class="ai-label" for="{{ form.title.id_for_label }}">Title</label>
              {{ form.title }}
              {{ form.title.errors }}
            </div>

            <div class="mb-2">
              <label class="ai-label d-flex justify-content-between align-items-center" for="{{ form.summary.id_for_label }}">
                <span>Summary</span>
                <small class="text-muted">Click inside a Summary to target formatter →</small>
              </label>
              {{ form.summary }}
              {{ form.summary.errors }}
            </div>

            <!-- {# Uncomment if you want the delete checkbox
            {% if form.DELETE %}
              <label class="form-check mt-2">
                {{ form.DELETE }} Delete
              </label>
            {% endif %}
            #} -->
          </div>
        {% endfor %}
      </div>

      <div class="d-flex gap-2">
        <button class="ai-btn" type="submit">Save</button>
        <a class="btn btn-outline-secondary" href="{% url 'SM_User:stockdata_crud' %}">Cancel</a>
      </div>
    </form>
  </div>
</div>

<!-- Text Formatter Toolbar -->
<nav id="tf-toolbar" class="tf-toolbar p-3">
  <div class="fw-semibold mb-2">Text Formatter</div>
  <div class="d-grid gap-2">
    <button type="button" class="btn btn-primary" onclick="tfFormat('bold')">Bold</button>
    <button type="button" class="btn btn-primary" onclick="tfFormat('title')">Title (H2)</button>
    <button type="button" class="btn btn-primary" onclick="tfFormat('para')">Normal Paragraph</button>
    <button type="button" class="btn btn-primary" onclick="tfFormat('list')">List</button>

    <div class="form-check mt-1">
      <input class="form-check-input" type="checkbox" id="tf-append-mode" checked>
      <label class="form-check-label" for="tf-append-mode">Append if no selection</label>
    </div>

    <hr class="my-2">
    <div class="small text-muted">Preview (last formatted)</div>
    <div id="tf-preview" class="tf-preview"></div>

    <button type="button" class="btn btn-outline-secondary" onclick="tfCopyLast()">Copy Last Snippet</button>
  </div>
</nav>

<!-- Bootstrap bundle (if not already included in base) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- DOMPurify for safe preview -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

<script>
  // Active Summary textarea
  let tfActiveTA = null;
  let tfLastSnippet = '';

  document.addEventListener('DOMContentLoaded', () => {
    const allSummaries = document.querySelectorAll('textarea[name$="-summary"]');
    allSummaries.forEach(ta => ta.addEventListener('focus', () => { tfActiveTA = ta; }));
    // fallback: set first summary as active
    if (!tfActiveTA && allSummaries.length) tfActiveTA = allSummaries[0];
  });

  function tfToggleToolbar(){
    const el = document.getElementById('tf-toolbar');
    if(!el) return;
    el.style.display = (el.style.display === 'none' ? '' : 'none');
  }

  // Utilities
  function tfEscape(text) {
    return text.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  }
  function tfSetPreview(html) {
    const el = document.getElementById('tf-preview');
    el.innerHTML = DOMPurify.sanitize(html, {
      ALLOWED_TAGS: ['h2','p','ul','li','span','b','strong','em'],
      ALLOWED_ATTR: ['style']
    });
  }
  function tfCopyLast() {
    if (!tfLastSnippet) { alert('Nothing to copy yet.'); return; }
    navigator.clipboard.writeText(tfLastSnippet).then(
      () => alert('Copied!'),
      () => alert('Copy failed')
    );
  }

  // Get selection or expand to current line
  function tfGetSelectedOrLine(ta) {
    const value = ta.value;
    let start = ta.selectionStart ?? 0;
    let end = ta.selectionEnd ?? 0;

    if (start !== end) return { start, end, text: value.slice(start, end), hadSelection: true };

    let lineStart = value.lastIndexOf('\n', start - 1);
    if (lineStart === -1) lineStart = 0; else lineStart += 1;
    let lineEnd = value.indexOf('\n', start);
    if (lineEnd === -1) lineEnd = value.length;

    return { start: lineStart, end: lineEnd, text: value.slice(lineStart, lineEnd), hadSelection: false };
  }

  // Replace selection while preserving caret + scroll (prevents jump-to-end)
  function tfReplaceRange(ta, start, end, replacement) {
    const prevScroll = ta.scrollTop;
    const before = ta.value.slice(0, start);
    const after  = ta.value.slice(end);
    ta.value = before + replacement + after;

    const pos = before.length + replacement.length;
    ta.focus();
    ta.setSelectionRange(pos, pos);

    // Restore scroll where it was before formatting
    ta.scrollTop = prevScroll;
    requestAnimationFrame(() => { ta.scrollTop = prevScroll; });
  }

  // Main formatter (Summary only)
  function tfFormat(type) {
    if (!tfActiveTA) {
      alert('Click inside a Summary field first.');
      return;
    }

    const appendIfNoSelection = document.getElementById('tf-append-mode').checked;

    // capture caret BEFORE computing replacement
    const selStart = tfActiveTA.selectionStart ?? 0;
    const selEnd   = tfActiveTA.selectionEnd ?? 0;
    const hadSelection = (selStart !== selEnd);

    const { start, end, text } = tfGetSelectedOrLine(tfActiveTA);
    const safeText = tfEscape(text.trim());
    let html = '';

    if (type === 'bold') {
      html = `<span>${safeText}</span>`;
      if (hadSelection) {
        tfReplaceRange(tfActiveTA, selStart, selEnd, html);
      } else {
        // insert at caret (or append to end of line if append mode)
        const insertAt = appendIfNoSelection ? end : selStart;
        tfReplaceRange(tfActiveTA, insertAt, insertAt, appendIfNoSelection ? html : `<p>${safeText || '&nbsp;'}</p>`);
      }
    } else if (type === 'title') {
      html = `<h2>${safeText || '&nbsp;'}</h2>`;
      tfReplaceRange(tfActiveTA, start, end, html);
    } else if (type === 'para') {
      html = `<p>${safeText || '&nbsp;'}</p>`;
      tfReplaceRange(tfActiveTA, start, end, html);
    } else if (type === 'list') {
      const lines = (safeText || '').split('\n').map(s => s.trim()).filter(Boolean);
      const items = lines.length ? lines.map(l => `  <li>${l}</li>`).join('\n') : '  <li>&nbsp;</li>';
      html = `<ul>\n${items}\n</ul>`;
      tfReplaceRange(tfActiveTA, start, end, html);
    }

    tfLastSnippet = html;
    tfSetPreview(html);
  }

  // Keyboard shortcuts (on active textarea only)
  document.addEventListener('keydown', (e) => {
    if (!tfActiveTA) return;
    if (e.ctrlKey || e.metaKey) {
      const k = e.key.toLowerCase();
      if (k === 'b') { e.preventDefault(); tfFormat('bold'); }
      if (k === 'l') { e.preventDefault(); tfFormat('list'); }
      if (k === '2') { e.preventDefault(); tfFormat('title'); }
      if (k === 'p') { e.preventDefault(); tfFormat('para'); }
    }
  });
</script>

{% endblock %}
